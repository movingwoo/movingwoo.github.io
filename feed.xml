<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="ko-KR"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://movingwoo.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://movingwoo.com/" rel="alternate" type="text/html" hreflang="ko-KR" /><updated>2025-12-16T02:12:51+00:00</updated><id>https://movingwoo.com/feed.xml</id><title type="html">뭐라도 하겠지</title><subtitle>개발, C++, JAVA, Python, Shortcut, 백준</subtitle><entry><title type="html">SSL 인증서 오류 해결</title><link href="https://movingwoo.com/server/2025/12/16/Fixing-SSL-Cert-Error.html" rel="alternate" type="text/html" title="SSL 인증서 오류 해결" /><published>2025-12-16T02:00:00+00:00</published><updated>2025-12-16T02:00:00+00:00</updated><id>https://movingwoo.com/server/2025/12/16/Fixing%20SSL%20Cert%20Error</id><content type="html" xml:base="https://movingwoo.com/server/2025/12/16/Fixing-SSL-Cert-Error.html"><![CDATA[<blockquote>
  <h4 id="상황">상황</h4>
  <hr />
</blockquote>

<p><img src="/assets/images/posts/Server/2025-12-16-Fixing SSL Cert Error/img01.webp" alt="img01" /></p>

<p>오 맙소사 이게 뭐야<br />
<span style="color: red;"><strong>Invalid SSL certificate</strong></span></p>

<p>뭔가 SSL 인증서 갱신이 제대로 이루어지지 않았나 보다.</p>

<blockquote>
  <h4 id="원인-분석">원인 분석</h4>
  <hr />
</blockquote>

<p>현재 SSL 인증서 발급 및 적용은 클라우드플레어에서 처리 중이다.<br />
대시보드를 확인해본다.</p>

<p><img src="/assets/images/posts/Server/2025-12-16-Fixing SSL Cert Error/img02.webp" alt="img02" /></p>

<p>2월 11일까지 3개월짜리 인증서가 정상적으로 적용되어있다.<br />
오류 사진에서도 클라이언트와 클라우드플레어 간 통신은 정상이다.</p>

<p>이러면 호스트 쪽을 봐야하는데…<br />
github pages를 사용하고 있으므로 github에 들어가 인증서 쪽을 확인해보자.</p>

<p><img src="/assets/images/posts/Server/2025-12-16-Fixing SSL Cert Error/img03.webp" alt="img03" /></p>

<p>DNS 검증이 되지 않고 있다.<br />
이게 원래는 됐었는데…</p>

<p>곰곰히 생각해보니 github pages TLS 적용을 최초에 진행했고<br />
나중에 cloudflare가 붙었다.<br />
아마 cloudflare가 붙으면서 그때부터 TLS 검증이 이루어지지 않은 것 같다.</p>

<p>대충 원인은 github으로 붙을때 HTTPS로 붙지 못해 발생한 것 같은데
민감 데이터도 없고 cloudflare 뒤의 백본이라 HTTP 통신만 이뤄져도 되는데 왜 SSL 오류가 떠버리지?</p>

<p><img src="/assets/images/posts/Server/2025-12-16-Fixing SSL Cert Error/img04.webp" alt="img04" /></p>

<p>결국 이 놈이 원인이었다.<br />
현재 암호화모드가 <span style="color: orange;"><strong>전체</strong></span>로 되어있는데<br />
이 모드에서는 cloudflare와 github pages 간의 암호화 통신이 이루어져야한다.</p>

<p>그런데 github 인증서가 만료되면서 도메인으로 Let’s Encrypt 인증서를 재발급하려 시도를 하였고<br />
이때 cloudflare 프록시에 걸리면서 인증서 재발급이 실패<br />
cloudflare는 인증서가 유효하지 않으니 호스트 통신 시 SSL 오류를 뱉은 것이다.</p>

<blockquote>
  <h4 id="조치">조치</h4>
  <hr />
</blockquote>

<p><img src="/assets/images/posts/Server/2025-12-16-Fixing SSL Cert Error/img05.webp" alt="img05" /></p>

<p>간단하게 암호화 모드를 <span style="color: orange;"><strong>가변</strong></span>으로 변경해준다.<br />
이렇게 되면 클라이언트와 클라우드플레어 암호화 통신은 유지하되<br />
클라우드플레어와 깃헙 간 통신은 평문 통신을 허용한다.</p>

<p>훔쳐갈 정보 자체가 없고 앞단에 클라우드플레어가 있기 때문에 보안상 문제는 크게 없다.</p>

<p>궁극적으로는 프록시를 타지 않게 해두고 github pages 인증서를 갱신 하는게 좋겠지만<br />
당장 그렇게까지 할 필요성을 못느끼겠다.</p>

<p>github pages DNS 설정부는 계속 DNS 체크 실패로 뜨고 HTTPS 강제가 불가능할 것이다.<br />
이대로 둔다고 해도 큰 문제는 안생기니 신경쓰지말고 냅두는 걸로</p>]]></content><author><name>movingwoo</name></author><category term="Server/" /><category term="SERVER" /><category term="CLOUDFLARE" /><category term="GITHUB" /><category term="장애" /><category term="복구" /><category term="SSL" /><summary type="html"><![CDATA[Cloudflare SSL 인증서 오류 해결]]></summary></entry><entry><title type="html">시스템 장애 복구 - docker와 traefik</title><link href="https://movingwoo.com/server/2025/11/11/Traefik-Failover.html" rel="alternate" type="text/html" title="시스템 장애 복구 - docker와 traefik" /><published>2025-11-11T02:00:00+00:00</published><updated>2025-11-11T02:00:00+00:00</updated><id>https://movingwoo.com/server/2025/11/11/Traefik%20Failover</id><content type="html" xml:base="https://movingwoo.com/server/2025/11/11/Traefik-Failover.html"><![CDATA[<blockquote>
  <h4 id="상황">상황</h4>
  <hr />
</blockquote>

<p>개인이 할 수 있는 최고의 보안 대책은 최신 업데이트이다.<br />
때문에 시간이 될 때마다 업데이트를 돌려주곤 하는데…</p>

<p>아무 생각없이 업데이트 진행 후 서비스 접속 시 <span style="color: orange;"><strong>404 page not found</strong></span> 오류가 다수 발생하기 시작했다.</p>

<p><img src="/assets/images/posts/Server/2025-11-11-Traefik Failover/img01.webp" alt="img01" /></p>

<p><span style="color: red;"><strong>아니 이게 무슨 일이야!!!!</strong></span></p>

<blockquote>
  <h4 id="원인-분석">원인 분석</h4>
  <hr />
</blockquote>

<p>우선 내부 컨테이너는 모두 정상 구동 중이다.<br />
도커 서비스와 클라우드플레어 서비스도 정상이다.</p>

<p>각 컨테이너 로그를 확인해보니 범인의 윤곽이 보인다.</p>

<p><img src="/assets/images/posts/Server/2025-11-11-Traefik Failover/img02.webp" alt="img02" /></p>

<p>메시지는 명확하다.<br />
<span style="color: orange;"><strong>1.24 버전이 너무 오래되었으니 최소 지원 버전인 1.44 이상으로 맞춰달라는 것.</strong></span></p>

<p>여기서 말하는 API 버전은 도커 API 버전이다.<br />
최신 업데이트를 진행하며 <span style="color: orange;"><strong>최소 지원 버전이 1.24 -&gt; 1.44</strong></span>로 높아졌는데<br />
트래픽에서 아직 1.24를 사용하는 건가 싶다.<br />
하지만 트래픽도 최신 이미지를 사용하는 중인데…<br />
아니면 도커 소켓이나 데몬에 문제가 있을 수도 있다.</p>

<p>트래픽 컨테이너 안에서 도커 소켓을 직접 호출해본다.</p>

<p><img src="/assets/images/posts/Server/2025-11-11-Traefik Failover/img03.webp" alt="img03" /></p>

<p>최소 API 버전은 1.44로 나오며
1.24 버전 강제 호출 시 같은 400 Bad Request 응답이 돌아온다.<br />
이러면 도커 소켓은 정상이고 트래픽이 1.24로 호출 중일 확률이 높다.</p>

<p><a href="https://docs.docker.com/engine/release-notes/29/">Docker Engine 29 release notes</a></p>

<p><img src="/assets/images/posts/Server/2025-11-11-Traefik Failover/img04.webp" alt="img04" /></p>

<p>오늘 아침에 도커 엔진이 29로 업데이트가 되었기 때문에 릴리즈 노트를 확인해본다.<br />
1.44 부터 필요하다는 내용이 확실히 있다.</p>

<p>즉, 트래픽은 1.24 버전 API를 사용하는데<br />
도커 엔진 업데이트로 인해 최소 1.44 버전 API를 요구해서<br />
트래픽이 도커 provider 초기화가 실패, 라우팅 실패, 404로 떨어진다는 뜻이다.</p>

<p><a href="https://pkg.go.dev/github.com/traefik/traefik/v3/pkg/provider/docker">Traefik Docker provider - pkg.go.dev</a></p>

<p><img src="/assets/images/posts/Server/2025-11-11-Traefik Failover/img05.webp" alt="img05" /></p>

<p>Go 패키지 확인 시 DockerAPIVersion이 1.24로 상수로 선언되어 있다.<br />
별다른 튜닝이나 업데이트가 가해지지 않았다면 아마 1.24로 동작할 것이다.</p>

<blockquote>
  <h4 id="조치">조치</h4>
  <hr />
</blockquote>

<p>가장 좋은 방법은 traefik에서 1.44 이상의 API를 사용하는 것인데<br />
겨우 그걸 위해 traefik 커스텀 이미지를 빌드하기는 아주 귀찮다.</p>

<p>언젠가 공식적인 지원을 기다리도록 하고<br />
당장 해결 가능한 방법은 <span style="color: orange;"><strong>도커 엔진 버전을 내리는 것</strong></span>이다.</p>

<p><img src="/assets/images/posts/Server/2025-11-11-Traefik Failover/img06.webp" alt="img06" /></p>

<p><span style="color: orange;"><strong>apt-cache madison docker-ce</strong></span> 명령어로 버전을 확인해본다.<br />
최신 29.0.0 빌드에서 문제가 생겼으므로 바로 아래의 28.5.2 빌드로 내리면 정상동작 할 것이다.<br />
<span style="color: orange;"><strong>docker-ce</strong></span> 외에 <span style="color: orange;"><strong>docker-ce-cli, docker-compose-plugin, docker-buildx-plugin, containerd.io</strong></span> 패키지도 버전을 체크한다.</p>

<p><img src="/assets/images/posts/Server/2025-11-11-Traefik Failover/img07.webp" alt="img07" /></p>

<p><img src="/assets/images/posts/Server/2025-11-11-Traefik Failover/img08.webp" alt="img08" /></p>

<p>다운그레이드 후 <span style="color: orange;"><strong>apt-mark hold</strong></span> 명령어로 업데이트 되지 않도록 패키지를 고정한다.</p>

<blockquote>
  <h4 id="추후-방안">추후 방안</h4>
  <hr />
</blockquote>

<p>당장은 docker 버전을 현 상태로 유지하는 수 밖에 없어보인다.</p>

<p>추후 traefik 공식 릴리즈를 확인하여 docker API 버전 관련 내용이 있으면<br />
패키지 고정한걸 풀어서 업데이트를 진행하면 되겠다.</p>

<p>그동안 생각없이 써왔는데<br />
도커가 제법 종속적이며 버전에 민감하다는 걸 알았다.<br />
으윽 나는 최신 업데이트를 하지 않으면 두드러기가 올라오는 병이 있는데</p>]]></content><author><name>movingwoo</name></author><category term="Server/" /><category term="SERVER" /><category term="ubuntu" /><category term="장애" /><category term="복구" /><category term="traefik" /><category term="docker" /><summary type="html"><![CDATA[traefik 장애 원인 분석 및 복구]]></summary></entry><entry><title type="html">OnlyOffice 서버 추가 구성</title><link href="https://movingwoo.com/server/service/2025/10/15/Install-Only-Office-Server.html" rel="alternate" type="text/html" title="OnlyOffice 서버 추가 구성" /><published>2025-10-15T05:00:00+00:00</published><updated>2025-10-15T05:00:00+00:00</updated><id>https://movingwoo.com/server/service/2025/10/15/Install%20Only%20Office%20Server</id><content type="html" xml:base="https://movingwoo.com/server/service/2025/10/15/Install-Only-Office-Server.html"><![CDATA[<blockquote>
  <h4 id="시작">시작</h4>
  <hr />
</blockquote>

<p>넥스트클라우드 앱을 보면 다양한 앱이 있는데<br />
기본적으로 딸려 설치되는 앱 중 PDF viewer 앱을 사용하면 pdf를 보는데는 문제가 없다.</p>

<p>하지만 엑셀이나 워드, 파워포인트 문서는 웹에서 뷰잉이 불가능하고 다운로드를 받아야한다.<br />
마소의 제 3자 문서 형식이라 어쩔 수 없는 부분이긴 한데<br />
웹에서 이놈들을 읽고 편집하려면 어떻게 해야하지?</p>

<blockquote>
  <h4 id="collabora-online와-only-office">Collabora Online와 Only Office</h4>
  <hr />
</blockquote>

<p>넥스트클라우드의 앱 메뉴에서 오피스 및 텍스트 섹션에 여러 문서 앱이 있다.<br />
이 중 사람들이 가장 많이 사용하는 것은 <span style="color: orange;"><strong>Nextcloud Office</strong></span>와 <span style="color: orange;"><strong>ONLYOFFICE</strong></span>의 2종이다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img01.webp" alt="img01" /></p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img02.webp" alt="img02" /></p>

<p>Nextcloud Office는 Collabora라는 오피스 제품인데 반쯤 넥스트 클라우드 공식으로 여겨지고 있는 듯 하다.<br />
둘을 비교해보면 대충 아래와 같다.</p>

<table>
  <thead>
    <tr>
      <th>항목</th>
      <th>Collabora (Nextcloud Office 기반)</th>
      <th>ONLYOFFICE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>엔진 / 기반</strong></td>
      <td>LibreOffice 기반. 서버에서 문서 렌더링 후 클라이언트에 타일/이미지 전송.</td>
      <td>클라이언트 측 편집 중심, 서버는 동기화/연산 담당.</td>
    </tr>
    <tr>
      <td><strong>파일 포맷 / 호환성</strong></td>
      <td>ODF(odt, ods 등) 기본 지원 강함. MS Office 포맷(docx, xlsx)은 지원하나 변환 오차 가능성 있음.</td>
      <td>OOXML(docx, xlsx, pptx) 호환성에 중점. 원본과 비슷한 레이아웃 유지 강점.</td>
    </tr>
    <tr>
      <td><strong>리소스 요구</strong></td>
      <td>서버에서 대부분 연산 처리 → 동시 접속 많으면 CPU/RAM 부담 큼.</td>
      <td>클라이언트 자원 활용 비중 높음 → 서버 부담 상대적으로 적음.</td>
    </tr>
    <tr>
      <td><strong>기능 범위</strong></td>
      <td>LibreOffice의 고급 기능들을 비교적 많이 제공. 복잡한 문서 편집 기능 강점.</td>
      <td>UI/UX가 직관적이고 MS Office와 유사. 단, 일부 고급 기능은 제한될 수 있음.</td>
    </tr>
    <tr>
      <td><strong>통합성</strong></td>
      <td>Nextcloud와 긴밀히 협력. Nextcloud Office의 기본 백엔드로 쓰임.</td>
      <td>독립 제품. Nextcloud와도 잘 연동되지만 기본 통합은 아님.</td>
    </tr>
    <tr>
      <td><strong>문제 / 버그</strong></td>
      <td>성능 저하, 메모리 과다 사용 보고 사례 있음.</td>
      <td>과거 문서 저장/캐시 관련 버그 사례 있음.</td>
    </tr>
  </tbody>
</table>

<p>정리하면, Collabora는 Nextcloud Office 앱으로 나올 정도로 긴밀하게 협력하고 있으며 리브레 오피스 기반인게 좋고<br />
Only Office는 MS 문서 호환이 잘되며 서버 부담이 적은게 좋다.</p>

<p>기본적으로 나는 <span style="color: orange;"><strong>공식</strong></span> 과 <span style="color: orange;"><strong>기본</strong></span> 을 좋아한다.<br />
애플 맥세이프 배터리팩을 산 호구가 바로 나다.</p>

<p>하지만 Collabora 사용에 문제가 있었으니…</p>

<blockquote>
  <h4 id="cloudflare-구성의-문제">Cloudflare 구성의 문제</h4>
  <hr />
</blockquote>

<p>현재 넥스트클라우드 서버는 클라우드플레어 터널을 통해 내부로 접근할 수 있게 해두었다.<br />
이 클라우드플레어가 문제가 되었다.</p>

<p>기본적으로 collabora든 onlyoffice든 nextcloud 서버와 쌍방 통신이 되어야한다.<br />
여기에 클라우드플레어가 끼어들면서 <span style="color: orange;"><strong>access 정책을 만족하지 못해 403오류</strong></span>로 떨어져버린다.<br />
넥스트클라우드와 오피스서버 통신이 안되니 뭐 어떻게 할 방법이 없다!!</p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img03.webp" alt="img03" /></p>

<p>지난번 확인했던 cloudflare 사용 시의 주의사항이다.<br />
<span style="color: red;"><strong>collabora does not work out of the box behind Cloudflare</strong></span> 라고 명확하게 써있다아뿔싸!!!!!<br />
해결하기 위해 IP 범위를 등록하라고 하는데 이것도 문제가 있다.</p>

<p>당연히 내 공인 IP를 넣어주면 될 줄 알았는데<br />
<span style="color: orange;"><strong>공인 IP를 넣어도 403오류</strong></span>가 발생했다.<br />
디버깅 결과 172로 시작하는 cloudflare 프록시로 추정되는 IP로 찍히고 있었다.<br />
또 클라우드플레어 너야???</p>

<p>해당 IP를 열어주면 문 활짝 열고 이랏샤이마세 하는 것과 비슷하기 때문에 IP 등록은 포기.</p>

<p><a href="https://help.nextcloud.com/">Nextcloud Community</a></p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img04.webp" alt="img04" /></p>

<p>커뮤니티 포럼에서 뒤져보니 cloudflare 이용 시 발생하는 문제에 관한 사용자들의 수많은 아우성이 존재한다.</p>

<p>사용자들의 성공적인 사례를 참조해보았는데<br />
cloudflare 치우고 웹서버 오픈, 엄격한 보안설정하는 방안은 관리가 너무 귀찮을 것 같아서 제외한다.</p>

<p>nextcloud 공식에서 추천하는 tailscale을 이용해 vpn 환경을 새로 구성하는 방안도 있었는데<br />
아 vpn 매번 키고 끄기 너무 귀찮을걸?<br />
손 안대는게 맞다고 생각했다.</p>

<p>이건 뭐 정말 방법이 없는걸까?</p>

<blockquote>
  <h4 id="수많은-실패와-성공적인-구성">수많은 실패와 성공적인 구성</h4>
  <hr />
</blockquote>

<p>성공적으로 오피스 서버를 구성하기 위해 아래의 조건이 필요했다.</p>
<ul>
  <li>onlyoffice
    <ul>
      <li>고급 설정에서 <span style="color: orange;"><strong>내부 통신</strong></span> 설정</li>
    </ul>
  </li>
  <li>web server
    <ul>
      <li><span style="color: orange;"><strong>동일 도메인 내</strong></span> context로 서버 분기</li>
    </ul>
  </li>
</ul>

<h4 id="1-onlyoffice">1. onlyoffice</h4>

<p>앞서 언급한 바와 같이 cloudflare가 끼면서 넥스트클라우드와 오피스서버 간 통신이 원활하지 않다.</p>

<p>판단하기로 collabora는 현재 구성에서는 적용이 전혀 불가능한데<br />
onlyoffice는 적용이 가능하다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img05.webp" alt="img05" /></p>

<p>onlyoffice 커넥터 설정 화면이다.<br />
고급 설정에서 <span style="color: orange;"><strong>내부 요청을 위한 http 주소 설정</strong></span>이 별도로 가능하다.<br />
collabora는 반드시 https 도메인을 통해야했는데 onlyoffice는 컨테이너 간 내부 통신이 가능해보인다.<br />
cloudflare를 거치지 않으면 아무 문제 없지 않을까?</p>

<h4 id="2-web-server">2. web server</h4>

<p>그럼에도 불구하고, 아무튼 오피스 서버에 붙을 수 있는 도메인은 마련해줘야했다.<br />
오피스용 서브도메인을 새로 파서 적용 후, cloudflare access 정책을 제거해보았다.</p>

<p>access 정책이 없으므로 nextcloud에서 office 서버로 통신은 아무 이상 없었지만<br />
<span style="color: orange;"><strong>office 서버에서 nextcloud로 통신 시 cloudflare access 정책에 걸려 403</strong></span>이 떨어진다.</p>

<p>내부 주소 설정과 별개로 대표 오피스 주소로 통신할 일이 있나보다…<br />
결국 오피스 서버와 넥스트클라우드가 같은 네트워크에 존재하게 하고 access 정책을 회피해야하는데<br />
cloudflare 정책을 건드려서 설정하기엔 무료 플랜에서 한계가 있었다.</p>

<p>따라서 <span style="color: orange;"><strong>웹서버</strong></span>를 두고 오피스 서버용 요청만 오피스 서버로 넘어가게 분기를 걸었다.<br />
onlyoffice는 이 설정으로 200 성공이 떨어졌는데<br />
collabora는 context 분기 시 다른 오류가 발생하여 사용할 수 없었다.</p>

<blockquote>
  <h4 id="기동-및-연동">기동 및 연동</h4>
  <hr />
</blockquote>

<p><a href="https://hub.docker.com/r/onlyoffice/documentserver">ONLYOFFICE - dockerhub</a></p>

<p>이미지는 <span style="color: orange;"><strong>documentserver</strong></span> 이미지를 사용한다.<br />
ee는 엔터프라이즈용이고 무료인 커뮤니티 에디션이 그냥 documentserver 이미지이다.</p>

<p>웹서버는 해외 포럼들 뒤져보면 caddy를 많이 사용하고<br />
내가 익숙한건 nginx인데<br />
설정 관리 포인트를 줄이고 싶어서 <span style="color: orange;"><strong>traefik</strong></span>을 사용한다.<br />
볼륨을 따로 잡을 필요가 없으며 설정 변경시 yml의 label 항목만 변경하면 된다.</p>

<h4 id="1-traefik">1. traefik</h4>

<p>yml에 traefik 컨테이너를 추가한다.<br />
네트워크도 추가하는데, 트래픽 분기용 traefik_net과 넥스트클라우드 구성에 포함될 nextcloud_net 2개로 만든다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">networks</span><span class="pi">:</span>
  <span class="na">traefik_net</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
  <span class="na">nextcloud_net</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">traefik</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">traefik:v3.5.3</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik_net</span>
      <span class="pi">-</span> <span class="s">nextcloud_net</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">--providers.docker=true</span>
      <span class="pi">-</span> <span class="s">--providers.docker.exposedbydefault=false</span>
      <span class="pi">-</span> <span class="s">--entrypoints.web.address=:80</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">80:80</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock:ro</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.enable=true"</span>
</code></pre></div></div>

<p>다른 서비스들에도 네트워크 설정을 해주고<br />
제일 중요한 nextcloud 서비스에 레이블을 잔뜩 붙여준다.</p>

<p>/office를 오피스 서버로 넘어가기로 결정했다면<br />
<span style="color: orange;"><strong>해당 prefix만 제외</strong></span>하고 넥스트클라우드로 넘어오게 하고<br />
<span style="color: orange;"><strong>우선도를 낮게</strong></span> 하여 오피스 서버로 갈 요청을 우선 판단하게 한다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">labels</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.enable=true"</span>
  <span class="c1"># 오피스 서버로 넘어갈 /office 컨텍스트 제외</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.app.rule=Host(`my.domain.com`)</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">!PathPrefix(`/office`)"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.app.entrypoints=web"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.services.app.loadbalancer.server.port=80"</span>
  <span class="c1"># 우선도를 낮게 유지</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.app.priority=1"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.app-httpshdr.headers.customrequestheaders.X-Forwarded-Proto=https"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.app-httpshdr.headers.customrequestheaders.X-Forwarded-Host=my.domain.com"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.app.middlewares=app-httpshdr@docker"</span>
</code></pre></div></div>

<h4 id="2-onlyoffice">2. onlyoffice</h4>

<p>환경변수에 <span style="color: orange;"><strong>JWT_SECRET</strong></span>은 나중에 설정 시 입력해야하니 잘 기억해야한다.<br />
레이블에 이것저것 막 넣다보니 엄청나게 길어졌는데<br />
아무튼 저렇게 쓰니까 되니 좋았쓰</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">office</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">onlyoffice/documentserver:latest</span>
  <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">traefik_net</span>
    <span class="pi">-</span> <span class="s">nextcloud_net</span>
  <span class="na">depends_on</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">app</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">JWT_ENABLED=true</span>
    <span class="pi">-</span> <span class="s">JWT_SECRET=</span>
    <span class="pi">-</span> <span class="s">JWT_HEADER=Authorization</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.enable=true"</span>
    <span class="c1"># 명시적으로 지정 안하니 오류나서</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.docker.network=traefik_net"</span>
    <span class="c1"># /office는 전부 onlyoffice를 통하도록</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.office.rule=Host(`my.domain.com`)</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">(PathPrefix(`/office`)</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">Path(`/office`))"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.office.entrypoints=web"</span>
    <span class="c1"># 우선도를 넥스트클라우드보다 높게 설정</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.office.priority=100"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.services.office.loadbalancer.server.port=80"</span>
    <span class="c1"># /office 잘라서 백엔드로 전달</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.office-strip.stripprefix.prefixes=/office"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.office-strip.stripprefix.forceSlash=true"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.office-httpshdr.headers.customrequestheaders.X-Forwarded-Proto=https"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.office-httpshdr.headers.customrequestheaders.X-Forwarded-Host=my.domain.com"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.office-httpshdr.headers.customrequestheaders.X-Forwarded-Prefix=/office"</span>
    <span class="c1"># 마지막 / 없는 접근 방지</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.office-slash.redirectregex.regex=^(.*/office)$"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.office-slash.redirectregex.replacement=$${1}/"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.office-slash.redirectregex.permanent=true"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.office.middlewares=office-slash@docker,office-strip@docker,office-httpshdr@docker"</span>
</code></pre></div></div>

<h4 id="3-기동">3. 기동</h4>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img06.webp" alt="img06" /></p>

<p>기동 시 onlyoffice 로그를 확인해보면 이것저것 바쁘게 설치하는게 보인다.<br />
nginx도 있고 postgre도 있고 rabbitmq도 있고 뭐가 많다.<br />
어쩐지 이미지가 묵직하더라니</p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img07.webp" alt="img07" /></p>

<p>넥스트클라우드 앱 메뉴에서 ONLYOFFICE를 설치하고 활성화한다.<br />
얘가 일종의 커넥터 역할을 하는 듯 하다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img08.webp" alt="img08" /></p>

<p>이후 관리자 설정 메뉴의 ONLYOFFICE 섹션에서 도메인과 내부 주소를 넣고<br />
JWT_SECRET을 넣어주고 저장을 눌렀을 때 오류가 안나면 성공이다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img09.webp" alt="img09" /></p>

<p>테스트를 위해 엑셀로 Hello World 파일을 만든다.<br />
이놈을 업로드해보자.</p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img10.webp" alt="img10" /></p>

<p>자동으로 썸네일 이미지를 왼쪽에 만들어준다.<br />
저 문서 자체에 내용이 없어서 새하얗게 보이는데 내용이 가득하면 썸네일도 제대로 보일 것이다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-10-15-Install Only Office Server/img11.webp" alt="img11" /></p>

<p>클릭해보면 다운로드가 아니라 onlyoffice를 통해 웹에서 내용을 수정, 편집할 수 있다.<br />
UI가 MS랑 유사해서 이질감이 적다.</p>

<p>아 이정도면 아주 훌륭하지<br />
<span style="color: red;"><strong>이제 나도 쓸 수 있다 웹 오피스</strong></span></p>

<blockquote>
  <h4 id="마무리">마무리</h4>
  <hr />
</blockquote>

<p>한계가 있다면<br />
일부 고급기능(얼마나 고급기능인지 잘 모르겠음)은 사용할 수 없다고 하고<br />
모바일에서 편집하려면 유료 라이선스가 필요하다.</p>

<p>하지만 모바일로 편집할 일은 딱히 없을 것 같고 열리긴 잘 열리며<br />
문서 내 간단한 SUMIF 같은 함수들도 잘 동작한다.</p>

<p>추석 전 부터 어떻게든 웹 오피스의 꿈을 이루려 노력했는데 상당히 오래걸렸다.<br />
중간에 마음이 꺾여서 웹 뷰어로 우회하려 했지만 포기하지 않길 잘했구나</p>]]></content><author><name>movingwoo</name></author><category term="Server/Service/" /><category term="SERVER" /><category term="SERVICE" /><category term="도커" /><category term="NEXTCLOUD" /><category term="ONLYOFFICE" /><summary type="html"><![CDATA[NextCloud + OnlyOffice 서버 추가 구성]]></summary></entry><entry><title type="html">Nextcloud 설치</title><link href="https://movingwoo.com/server/service/2025/09/17/Install-Nextcloud.html" rel="alternate" type="text/html" title="Nextcloud 설치" /><published>2025-09-17T08:00:00+00:00</published><updated>2025-09-17T08:00:00+00:00</updated><id>https://movingwoo.com/server/service/2025/09/17/Install%20Nextcloud</id><content type="html" xml:base="https://movingwoo.com/server/service/2025/09/17/Install-Nextcloud.html"><![CDATA[<blockquote>
  <h4 id="머리말">머리말</h4>
  <hr />
</blockquote>

<p>1호기에 Nextcloud가 있긴 했는데<br />
보안관리가 귀찮아 잘 안쓰고 있었다.</p>

<p>뭐 파일도 몇 개 없었으니 이 기회에 새로 올리자.</p>

<blockquote>
  <h4 id="nextcloud-란">Nextcloud 란?</h4>
  <hr />
</blockquote>

<p><img src="/assets/images/posts/Server/Service/2025-09-17-Install Nextcloud/img01.webp" alt="img01" /></p>

<p><span style="color: orange;"><strong>Nextcloud</strong></span>는 오픈소스 기반 클라우드 스토리지 및 협업 플랫폼이다.<br />
협업할 일은 없으니 갖다치우고, 오픈소스 스토리지 서비스를 이용한다고 보면 된다.</p>

<p>확장성이 좋고 제공하는 앱이 다양해 기능이 상당히 강력하다.<br />
그만큼 무거워지기 쉬운 점은 단점이다.</p>

<p>이런 서비스 특성 상 보안이슈 터지면 감당이 안되는데<br />
클라우드플레어 방패 뒤에 숨으면 보안 부담을 상당히 덜 수 있다.</p>

<blockquote>
  <h4 id="계획">계획</h4>
  <hr />
</blockquote>

<p><a href="https://github.com/nextcloud/all-in-one#nextcloud-all-in-one">Nextcloud All-in-One - github</a></p>

<p>예전에는 없었던 것 같은데<br />
github에 올인원 설치 가이드가 생겼다.<br />
내용이 굉장히 알차게 작성되어있어 정독할 필요가 있다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-09-17-Install Nextcloud/img02.webp" alt="img02" /></p>

<p>읽는 중 이 부분이 눈에 밟혔는데…<br />
Cloudflare Tunnel 사용 시 발생할 수 있는 문제점에 관해 다루고 있다.<br />
이 때문에 Tailscale 사용을 권장하고 있다.</p>

<p>일단 써보고 뭐가 문제인지 몸으로 파악하자…<br />
Tailscale은 예전에 들어본 적 있긴한데 언젠가 한 번 써볼 기회가 올지 모르겠다.</p>

<p>DB는 Mysql(MariaDB), Postgres, SQLite 3개를 지원하는 것으로 보인다.<br />
SQLite는 집어치우고 <span style="color: orange;"><strong>MariaDB</strong></span>를 선택한다.<br />
Postgres가 좋은 DB라고 알고는 있는데 직접 써본 경험이 너무 적어서 꺼려진다.</p>

<p>1호기 당시 최대한 가볍게 구동하려 Redis를 제외했는데<br />
3호기는 스펙이 빵빵하니 <span style="color: orange;"><strong>Redis</strong></span>를 추가한다.</p>

<blockquote>
  <h4 id="설치">설치</h4>
  <hr />
</blockquote>

<h4 id="1-docker-composeyml-작성">1. docker-compose.yml 작성</h4>

<p><a href="https://hub.docker.com/_/nextcloud">Nextcloud - Docker Hub</a></p>

<p><img src="/assets/images/posts/Server/Service/2025-09-17-Install Nextcloud/img03.webp" alt="img03" /></p>

<p>도커 허브에 기초적인 yml 작성 가이드가 있다.<br />
이를 토대로 작성하되 커스텀이 필요하다.</p>

<p>마리아디비는 안정적인 것 같은 <span style="color: orange;"><strong>10.11</strong></span> 버전을 하고<br />
redis는 <span style="color: orange;"><strong>7.2</strong></span> 버전에 최대한 가벼운 <span style="color: orange;"><strong>alpine</strong></span> 이미지를 선택한다.<br />
nextcloud는 <span style="color: orange;"><strong>31</strong></span>버전에 <span style="color: orange;"><strong>apache</strong></span>가 포함된 이미지를 선택한다.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">database</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mariadb:10.11</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">--transaction-isolation=READ-COMMITTED --binlog-format=ROW --skip-log-bin --innodb-file-per-table=1</span> <span class="c1"># command 추가</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">MYSQL_ROOT_PASSWORD</span><span class="pi">:</span> 
      <span class="na">MYSQL_DATABASE</span><span class="pi">:</span> <span class="s">nextcloud</span>
      <span class="na">MYSQL_USER</span><span class="pi">:</span> <span class="s">nextcloud</span>
      <span class="na">MYSQL_PASSWORD</span><span class="pi">:</span> 
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/app/nextcloud/mysql:/var/lib/mysql</span>
    <span class="na">healthcheck</span><span class="pi">:</span> <span class="c1"># 헬스체크용 추가</span>
      <span class="na">test</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mysqladmin</span><span class="nv"> </span><span class="s">ping</span><span class="nv"> </span><span class="s">-h</span><span class="nv"> </span><span class="s">localhost"</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="s">5s</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">10</span>

  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">redis:7.2-alpine</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">command</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">redis-server</span>
      <span class="pi">-</span> <span class="s">--appendonly yes</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/app/nextcloud/redis:/data</span>

  <span class="na">app</span><span class="pi">:</span> <span class="c1"># 앱 본체</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nextcloud:31-apache</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">database</span>
      <span class="pi">-</span> <span class="s">redis</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">8080:80</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">MYSQL_HOST</span><span class="pi">:</span> <span class="s">database</span>
      <span class="na">MYSQL_DATABASE</span><span class="pi">:</span> <span class="s">nextcloud</span>
      <span class="na">MYSQL_USER</span><span class="pi">:</span> <span class="s">nextcloud</span>
      <span class="na">MYSQL_PASSWORD</span><span class="pi">:</span> 
      <span class="na">REDIS_HOST</span><span class="pi">:</span> <span class="s">redis</span>
      <span class="na">PHP_MEMORY_LIMIT</span><span class="pi">:</span> <span class="s">1024M</span>
      <span class="na">PHP_UPLOAD_LIMIT</span><span class="pi">:</span> <span class="s">10G</span>
      <span class="na">NEXTCLOUD_TRUSTED_DOMAINS</span><span class="pi">:</span> <span class="s2">"</span><span class="s">domain"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nextcloud_html:/var/www/html</span> 
      <span class="pi">-</span> <span class="s">/app/nextcloud/data:/var/www/html/data</span> 
      <span class="pi">-</span> <span class="s">/app/nextcloud/config:/var/www/html/config</span> 
      <span class="pi">-</span> <span class="s">/app/nextcloud/custom_apps:/var/www/html/custom_apps</span> 
      <span class="pi">-</span> <span class="s">/app/nextcloud/themes:/var/www/html/themes</span> 

  <span class="na">cron</span><span class="pi">:</span> <span class="c1"># 크론</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nextcloud:31-apache</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">depends_on</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">database</span>
      <span class="pi">-</span> <span class="s">redis</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nextcloud_html:/var/www/html</span>
      <span class="pi">-</span> <span class="s">/app/nextcloud/data:/var/www/html/data</span> 
      <span class="pi">-</span> <span class="s">/app/nextcloud/config:/var/www/html/config</span> 
      <span class="pi">-</span> <span class="s">/app/nextcloud/custom_apps:/var/www/html/custom_apps</span> 
      <span class="pi">-</span> <span class="s">/app/nextcloud/themes:/var/www/html/themes</span> 
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/cron.sh</span>

<span class="na">volumes</span><span class="pi">:</span> <span class="c1"># 크론에서 이용하기 위한 공유 볼륨</span>
  <span class="na">nextcloud_html</span><span class="pi">:</span>
</code></pre></div></div>

<h4 id="2-기동-및-설치">2. 기동 및 설치</h4>

<p>기동 전 nextcloud 기준 /var/www/html 하위 폴더에 대한 권한을 줘야한다.<br />
www-data 계정에 권한을 줘야하는데 uid, gid가 33이다.<br />
<span style="color: orange;"><strong>chown -R 33:33 대상폴더</strong></span> 명령어로 일괄 권한부여를 진행한다.</p>

<p>예전 설치했을 때 볼륨을 따로 잡아두고 권한을 주지 않으면 설치 시 권한 오류가 발생해서 재기동이 필요했다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-09-17-Install Nextcloud/img04.webp" alt="img04" /></p>

<p>이후 <span style="color: orange;"><strong>docker compose up -d</strong></span> 명령어로 기동</p>

<p><img src="/assets/images/posts/Server/Service/2025-09-17-Install Nextcloud/img05.webp" alt="img05" /></p>

<p>브라우저로 접속 시 초기화면이 나온다.<br />
관리자 계정을 설정하면 최초 설치를 진행하고<br />
추천 앱을 설치하든 말든 하면 메인화면을 확인할 수 있다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-09-17-Install Nextcloud/img06.webp" alt="img06" /></p>

<h4 id="3-추가-설정">3. 추가 설정</h4>

<p>이대로 그냥 쓸 수 있긴한데 추가 설정을 일부 진행한다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-09-17-Install Nextcloud/img07.webp" alt="img07" /></p>

<p>yml에 옵션 넣은 부분도 혹시 모르니 재확인한다.<br />
redis를 명확히 지정하고 백그라운드 작업도 크론으로 설정한다.</p>

<p>이전에 백그라운드 작업을 ajax로 했더니 성능이 속터질정도로 답답했던 기억이 있다.</p>

<p>그리고 클라우드플레어 업로드 제한을 회피하기 위해 청크 사이즈를 설정한다.<br />
여유있게 <span style="color: orange;"><strong>94371840 byte</strong></span>로 설정한다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 리전</span>
php occ config:system:set default_phone_region <span class="nt">--value</span><span class="o">=</span>KR
<span class="c"># redis 관련</span>
php occ config:system:set memcache.local <span class="nt">--value</span><span class="o">=</span><span class="s1">'\OC\Memcache\APCu'</span>
php occ config:system:set memcache.locking <span class="nt">--value</span><span class="o">=</span><span class="s1">'\OC\Memcache\Redis'</span>
php occ config:system:set redis host <span class="nt">--value</span><span class="o">=</span><span class="s1">'redis'</span>
php occ config:system:set redis port <span class="nt">--value</span><span class="o">=</span><span class="s1">'6379'</span> <span class="nt">--type</span><span class="o">=</span>integer
<span class="c"># 크론 설정</span>
php occ background:cron
<span class="c"># 청크 사이즈 설정 (100mb 제한 회피)</span>
php occ config:app:set files max_chunk_size <span class="nt">--value</span> 94371840
<span class="c"># 신뢰할 수 있는 도메인</span>
php occ config:system:set overwrite.cli.url <span class="nt">--value</span><span class="o">=</span><span class="s2">"https://도메인"</span>
<span class="c"># mimetype 마이그</span>
php occ maintenance:repair <span class="nt">--include-expensive</span>
</code></pre></div></div>

<p>어디까지 설정해야 하느냐가 문제인데…<br />
관리자 메뉴의 보안 쪽을 보면 nextcloud에서 시스템 확인 후 <span style="color: red;"><strong>보안 경고</strong></span>를 보여준다.</p>

<p><img src="/assets/images/posts/Server/Service/2025-09-17-Install Nextcloud/img08.webp" alt="img08" /></p>

<p>보안경고를 모두 없앤다는 생각으로 설정을 진행하면 된다.</p>

<blockquote>
  <h4 id="꼬리말">꼬리말</h4>
  <hr />
</blockquote>

<p>1호기 때 고생을 많이 했더니 굉장히 쉽게 설치했다.<br />
yml 새로 작성하기는 머리가 아팠지만 덕분에 결과물이 만족스럽다.</p>]]></content><author><name>movingwoo</name></author><category term="Server/Service/" /><category term="SERVER" /><category term="SERVICE" /><category term="도커" /><category term="NEXTCLOUD" /><summary type="html"><![CDATA[도커 활용 Nextcloud 첫 설치]]></summary></entry><entry><title type="html">Cloudflare Tunnel 설정</title><link href="https://movingwoo.com/server/2025/09/16/Setting-Cloudflare-Tunnel.html" rel="alternate" type="text/html" title="Cloudflare Tunnel 설정" /><published>2025-09-16T03:00:00+00:00</published><updated>2025-09-16T03:00:00+00:00</updated><id>https://movingwoo.com/server/2025/09/16/Setting%20Cloudflare%20Tunnel</id><content type="html" xml:base="https://movingwoo.com/server/2025/09/16/Setting-Cloudflare-Tunnel.html"><![CDATA[<blockquote>
  <h4 id="머리말">머리말</h4>
  <hr />
</blockquote>

<p>테스트를 위해 Cloudflare Tunnel을 적용해보는 시간.</p>

<blockquote>
  <h4 id="cloudflare-tunnel이란">Cloudflare Tunnel이란?</h4>
  <hr />
</blockquote>

<p><span style="color: orange;"><strong>Cloudflare Tunnel</strong></span>은 서버를 인터넷에 안전하게 노출하는 방법 중 하나이다.</p>

<p>서버에 <span style="color: orange;"><strong>cloudflared 클라이언트</strong></span>를 설치하고, 클라이언트를 통해 cloudflare로 아웃바운드 연결을 맺는다.<br />
클라이언트와 cloudflare가 직접 통신하는 구조라 <span style="color: orange;"><strong>방화벽이나 IP를 노출할 필요가 없다.</strong></span><br />
덕분에 방화벽은 인바운드를 다 막고 아웃바운드만 허용하면 된다.</p>

<p><span style="color: orange;"><strong>모든 것을 cloudflare에게 맡기기</strong></span></p>

<blockquote>
  <h4 id="사전-작업">사전 작업</h4>
  <hr />
</blockquote>

<p>터널을 설정하는 제로 트러스트 대시보드는 클라우드플레어 대시보드와 별도로 존재한다.<br />
왜 이렇게 불편한 구조가 되었냐?</p>

<p>원래 출신이 달랐다고 한다.<br />
Teams/Access 제품군이 별도로 있었는데 Cloudflare가 나중에 인수하여 한 몸이 되었다.</p>

<p>메인 대시보드에 Zero Trust 메뉴로 이동하는 버튼을 달아두긴 했는데<br />
완전히 합쳐지기에는 시간이 조금 더 필요해보인다.</p>

<p><a href="https://one.dash.cloudflare.com/">Cloudflare Zero Trust Dashboard</a></p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img01.webp" alt="img01" /></p>

<p>cloudflare 계정으로 진행하면 팀 이름을 선택해야한다.<br />
제로 트러스트 쪽은 팀 기준으로 운영된다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img02.webp" alt="img02" /></p>

<p>무료 플랜에 보면 50명 사용자 제한이 있다.<br />
개인 사용에 아무런 문제가 없다.</p>

<p>그 밖에 일부 보안 세부 제한이 있지만 터널은 무료기 때문에 사용에 문제 없다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img03.webp" alt="img03" /></p>

<p>로그인 후 터널 설정 메뉴에 접근할 수 있다.</p>

<p>테스트해볼 서버에도 붙어서 사전 작업을 진행한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img04.webp" alt="img04" /></p>

<p>방화벽의 Inbound를 모두 deny하고 SSH를 제외한 포트를 전부 닫는다.<br />
SSH에도 터널 적용이 가능한데 굳이 그럴 필요가 있나 싶어서 일단 냅둔다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img05.webp" alt="img05" /></p>

<p>터널 접속 테스트를 위한 톰캣을 하나 올린다.<br />
http 8080 기본 포트 하나만 설정했다.</p>

<blockquote>
  <h4 id="cloudflare-tunnel-설정">Cloudflare Tunnel 설정</h4>
  <hr />
</blockquote>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img06.webp" alt="img06" /></p>

<p>권장 설정인 cloudflared를 선택한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img07.webp" alt="img07" /></p>

<p>서버에 cloudflared 설치하는 방법에 대한 가이드가 나온다.<br />
안정적인 사용을 위해 repo를 등록하는게 좋다고 한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img08.webp" alt="img08" /></p>

<p>서비스까지 등록되면 systemd 에 cloudflared 가 active 상태인걸 확인할 수 있다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img09.webp" alt="img09" /></p>

<p>연결 정책을 설정한다.<br />
테스트 서브도메인을 설정하고 내부 톰캣 주소인 localhost:8080 과 매핑한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img10.webp" alt="img10" /></p>

<p>설정한 도메인으로 연결 시 클라우드플레어에서 제공해준 TLS 인증서와 함께 내부 톰캣에 접속 가능하다.<br />
분명 방화벽에서 8080 포트를 열지 않았지만 터널을 통해 접근 가능하다.</p>

<p><span style="color: red;"><strong>모든 것을 cloudflare에게 맡기기…</strong></span></p>

<blockquote>
  <h4 id="추가-보안-설정">추가 보안 설정</h4>
  <hr />
</blockquote>

<p>제로 트러스트 대시보드에서 보안 설정을 확인해보니 Access 정책 설정이 가능했다.<br />
<span style="color: orange;"><strong>Access &gt; 정책</strong></span> 메뉴에서 해당 호스트 접근에 대한 추가적인 정책을 걸어둔다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img11.webp" alt="img11" /></p>

<p>도메인에 대하여 이메일 인증을 거치도록 설정했다.<br />
포함, 제외, 필수 등 다양한 방식으로 설정이 가능하다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img12.webp" alt="img12" /></p>

<p>도메인 접근 시 사진과 같이 이메일 OTP 인증 화면이 나온다.<br />
서비스 로그인 화면 이전에 cloudflare에서 자체적인 접근제어를 진행하는 것이다.<br />
아주 훌륭하다.</p>

<p>이것 외에 cloudflare 대시보드에서 <span style="color: orange;"><strong>보안 &gt; 보안 규칙</strong></span> 탭에서 추가적인 규칙을 설정할 수 있다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img13.webp" alt="img13" /></p>

<p>and or in not 등으로 규칙을 설정할 수 있는데<br />
로컬 그룹 IP를 제외한 나머지에게 관리 챌린지를 걸어두었다.</p>

<p>관리 챌린지가 대체 무어냐?</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Setting Cloudflare Tunnel/img14.webp" alt="img14" /></p>

<p>휴대폰으로 접속해보았다.<br />
어디서 많이 본 인증화면이 나온다.</p>

<p>그렇다! 이것이 관리 챌린지였다!</p>

<blockquote>
  <h4 id="꼬리말">꼬리말</h4>
  <hr />
</blockquote>

<p>이게 어디까지가 무료인가?<br />
그 범위를 파악하며 설정해야하다보니 골치가 아프다.</p>

<p>그래도 무료치고 기능이 엄청나게 좋다.<br />
이러니 다들 클라우드플레어 쓰지.</p>

<p>굳이 단점을 찾아보자면</p>
<ul>
  <li><span style="color: orange;"><strong>모든 트래픽이 cloudflare를 경유</strong></span>해서 cloudflare가 터지면 같이 터짐</li>
  <li>cloudflare가 트래픽 내용을 볼 수 있어서 <span style="color: orange;"><strong>프라이버시</strong></span> 우려가 있음</li>
  <li>cloudflare 계정이나 정책에 이슈가 생기면 접근이 안되기 때문에 백도어 마련 필요</li>
  <li>대규모 업/다운로드 시 무료 플랜에서 힘들거나 속도 저하가 생길 수 있음</li>
</ul>

<p>이 정둔가?<br />
아직은 제대로 사용도 안해봤기 때문에 단점을 제대로 느끼려면 롱텀으로 사용해봐야 알 것 같다.</p>

<p>이제 무슨 서비스를 올려볼지 고민해야지.</p>]]></content><author><name>movingwoo</name></author><category term="Server/" /><category term="SERVER" /><category term="CLOUDFLARE" /><category term="TUNNEL" /><category term="보안" /><summary type="html"><![CDATA[Cloudflare Tunnel 및 추가 보안 설정]]></summary></entry><entry><title type="html">도메인 네임서버 변경</title><link href="https://movingwoo.com/server/2025/09/15/Migrating-Domain.html" rel="alternate" type="text/html" title="도메인 네임서버 변경" /><published>2025-09-15T08:00:00+00:00</published><updated>2025-09-15T08:00:00+00:00</updated><id>https://movingwoo.com/server/2025/09/15/Migrating%20Domain</id><content type="html" xml:base="https://movingwoo.com/server/2025/09/15/Migrating-Domain.html"><![CDATA[<blockquote>
  <h4 id="머리말">머리말</h4>
  <hr />
</blockquote>

<p>Cloudflare Tunnel 을 사용하기 위한 사전 작업이 있다.<br />
<span style="color: orange;"><strong>도메인 네임서버를 Cloudflare로 변경</strong></span>해야한다.</p>

<p>정말 귀찮기 그지없는 작업이지만 일단 해보자.</p>

<p>현재 글을 올리는 movingwoo.com 도메인은 porkbun 에서 구입하여 이용 중이다.<br />
이 도메인의 네임서버를 cloudflare 로 이전한다.</p>

<blockquote>
  <h4 id="cloudflare란">Cloudflare란?</h4>
  <hr />
</blockquote>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img01.webp" alt="img01" /></p>

<p>사실 인터넷 좀 해봤으면 cloudflare에 대해 한 번 쯤은 봤을 확률이 높다.<br />
대충 서버 터졌을때 클라우드플레어 어쩌고 저쩌고 뜬다.</p>

<p>그만큼 많이들 사용하는 인프라 서비스 회사인데, 2010년 설립되었다고 한다.<br />
생각보다 후발주자이다.<br />
그래도 무료 플랜 접근성이 좋고 간편하여 빠르게 성장하여 지금의 cloudflare가 되었다고 한다.</p>

<p>무료 플랜이 강력하긴 한데 회사가 커지면서 일부 보안 기능들이 유료화되어가는 추세라는데…<br />
일단 터널은 무료로 제공해주니 써보자.<br />
즐길 수 있을때 즐겨야지</p>

<blockquote>
  <h4 id="네임서버-변경-작업">네임서버 변경 작업</h4>
  <hr />
</blockquote>

<p><a href="https://dash.cloudflare.com/">Cloudflare Dashboard</a></p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img02.webp" alt="img02" /></p>

<p>가입하면 도메인을 등록하라고 뜬다.<br />
순서대로 하라는대로 진행하면 된다.</p>

<p>한국어 지원 해주는게 마음에 든다.<br />
품질도 정말 나쁘지 않다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img03.webp" alt="img03" /></p>

<p>DNS 레코드 추가는 <span style="color: orange;"><strong>빠른 스캔</strong></span>으로 진행한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img04.webp" alt="img04" /></p>

<p>플랜 선택 화면.<br />
당연히 <span style="color: orange;"><strong>무료 플랜</strong></span>을 선택하겠지만, 프로 플랜부터 기능이 매력적이긴하다.</p>

<p>사실 1개월 20딸라면 요즘 AI 구독과 비슷한 가격이다.<br />
막 접근성이 없진 않은 가격이다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img05.webp" alt="img05" /></p>

<p>빠른 스캔으로 가져온 DNS 레코드 리스트가 뜬다.</p>

<p>포크번에서 자동으로 긁어온 리스트인데<br />
기존 등록되어있는 A 레코드와 TXT 레코드 외에 NS 레코드가 보인다.<br />
포크번 네임서버 리스트인데 우선은 그대로 가져간다.</p>

<p>NS 레코드는 네임서버 이전이 완료되면 안전하게 삭제하도록 한다.<br />
사실 잘 모르면 손대지 않고 냅두는게 최고다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img06.webp" alt="img06" /></p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img07.webp" alt="img07" /></p>

<p>마지막 단계를 위해 기존 도메인 등록기관, 내 경우 포크번에 로그인이 필요하다.<br />
<span style="color: orange;"><strong>DNSSEC 기능을 종료</strong></span> 후, <span style="color: orange;"><strong>네임 서버를 cloudflare에서 제공해주는 값으로 교체</strong></span>한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img08.webp" alt="img08" /></p>

<p>이 부분은 시간이 상당 소요될 수 있는데<br />
나는 트래픽 쥐꼬리만큼도 없는 싸구려 도메인이라 바로 처리됨…</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img09.webp" alt="img09" /></p>

<p>대시보드에서 상태가 <span style="color: orange;"><strong>활성</strong></span>으로 나오면 끝이다.</p>

<blockquote>
  <h4 id="추가-보안-작업">추가 보안 작업</h4>
  <hr />
</blockquote>

<p>아까 DDNSEC을 종료했으므로 DDNSEC을 활성화 시켜야하고<br />
TLS와 같은 기초적인 설정도 마저 진행한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img10.webp" alt="img10" /></p>

<p>딸깍으로 SSL/TLS 자동 적용.<br />
원래 이부분은 포크번도 딸깍으로 했던 것 같다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img11.webp" alt="img11" /></p>

<p>DNSSEC 활성화를 하려면 <span style="color: orange;"><strong>DS 레코드를 등록기관에 추가</strong></span>해야한다.</p>

<p>만약 내가 도메인 자체를 클라우드플레어로 이전했다면 이부분은 간단하게 끝났겠지만<br />
네임서버만 변경한거라 이 작업은 포크번에 직접 해줘야한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img12.webp" alt="img12" /></p>

<p>제공해주는 값들을 그대로 입력해주기만 하면 된다.</p>

<p>이것은 간단한 레고조립과 같다.<br />
아기들 모양 맞춰서 블럭 넣는 장난감과 다름 없다.<br />
맞는 칸에 넣고 없는 칸은 비우고 등록한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img13.webp" alt="img13" /></p>

<p><span style="color: red;"><strong>잉?</strong></span></p>

<p>시간이 지나도 등록이 안되어 문의 결과, keyData 쪽 입력 때문에 검증 실패로 오류가 나는 것이라 한다.<br />
keyData 제외하고 <span style="color: orange;"><strong>dsData 쪽만 입력</strong></span>해주면 성공적으로 등록된다…</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img14.webp" alt="img14" /></p>

<p>클라우드플레어 대시보드에서도 DNSSEC 적용을 확인할 수 있다.</p>

<blockquote>
  <h4 id="꼬리말">꼬리말</h4>
  <hr />
</blockquote>

<p>이 외 보안 관련 다양한 메뉴들이 있는데 대부분 프로 플랜 이상을 권유하고 있어서 쓰기 힘들다.<br />
봇 막는 기능 등은 무료인데 굳이 막아야하나 싶기도 하고…</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img15.webp" alt="img15" /></p>

<p>제일 안타까운건 이 최대 업로드 크기 부분인데<br />
100mb 제한이 있고 비즈니스 플랜부터 늘릴 수 있다.</p>

<p><img src="/assets/images/posts/Server/2025-09-16-Migrating Domain/img16.webp" alt="img16" /></p>

<p>이렇게 <span style="color: orange;"><strong>오렌지색 구름 모양</strong></span>으로 클라우드플레어 프록시를 거치는 경우 저 제한이 적용된다.<br />
개인 서버라 큰 이슈는 없을 것 같은데 일단 사용해봐야 알 것 같다.<br />
가늠이 잘 안가는데, 제한 때문에 문제생기면 프록시 풀거나 하면 되겠지.</p>]]></content><author><name>movingwoo</name></author><category term="Server/" /><category term="SERVER" /><category term="도메인" /><category term="네임서버" /><category term="CLOUDFLARE" /><summary type="html"><![CDATA[Cloudflare로 도메인 네임서버 변경]]></summary></entry><entry><title type="html">Traefik 구축, 설정</title><link href="https://movingwoo.com/server/web/2025/09/15/Setting-Traefik.html" rel="alternate" type="text/html" title="Traefik 구축, 설정" /><published>2025-09-15T06:00:00+00:00</published><updated>2025-09-15T06:00:00+00:00</updated><id>https://movingwoo.com/server/web/2025/09/15/Setting%20Traefik</id><content type="html" xml:base="https://movingwoo.com/server/web/2025/09/15/Setting-Traefik.html"><![CDATA[<blockquote>
  <h4 id="머리말">머리말</h4>
  <hr />
</blockquote>

<p>원래 이번 3호기 구축하며 cloudflare tunnel을 사용해볼 생각이었다.<br />
포트를 열지 않고 보안을 cloudflare에 맡겨버리는게 상당히 매력적인 선택지다.</p>

<p>보안 설정을 직접 해야한다면 상당히 피곤하지만 재미는 있다.<br />
만약 cloudflare tunnel을 쓰지 않고 직접 포트 열고 웹서버를 구축해서 사용한다면?</p>

<p>nginx 정도는 여러 번 사용해봤고, SSL 인증서 자동 갱신을 위해 acme-companion까지 사용해본 적 있다.<br />
한 번 설정하면 다시는 손대기 싫은게 단점이었는데<br />
<span style="color: orange;"><strong>traefik</strong></span>을 사용하면 더 적은 설정으로 HTTPS, 라우팅, 보안 미들웨어까지 해결해준다고 한다.</p>

<p>경험삼아 traefik을 한 번 설정해보자.</p>

<blockquote>
  <h4 id="traefik이란">Traefik이란?</h4>
  <hr />
</blockquote>

<p><img src="/assets/images/posts/Server/WEB/2025-09-15-Setting Traefik/img01.webp" alt="img01" /></p>

<p>요 캐릭터는 많이 봤다.</p>

<p>traefik은 <span style="color: orange;"><strong>레이블 기반 선언형 라우팅</strong></span>을 사용해서<br />
각 서비스 컨테이너에 레이블만 달아주면 알아서 도메인 매핑, 경로 라우팅을 해준다.<br />
traefik <span style="color: orange;"><strong>자체적으로 인증서 발급, 갱신</strong></span>을 해주기도 한다.<br />
보안 미들웨어도 내장하고 있고, 로그 경로를 호스트에 마운트해서 fail2ban과 연계할 수도 있다.</p>

<p>레이블만 대충 바꿔주면 된다는 점이 매력포인트다.<br />
관리포인트는 적어질수록 좋다.</p>

<p>대시보드도 제공하는데 별로 필요없어 보여서 대시보드는 제외하고 설정한다.<br />
괜히 쓸데없는 노출이 늘어나는 것이기도 하다.<br />
그냥 로그 보면 다 나오는데 뭔 대시보드야</p>

<blockquote>
  <h4 id="설정-및-기동">설정 및 기동</h4>
  <hr />
</blockquote>

<h5 id="1-docker-composeyml">1. docker-compose.yml</h5>

<p>도커로 올린다.<br />
레이블 설정까지 정상적으로 먹히는지 확인하기 위해 빈 서비스로 tomcat 깡통을 하나 같이 올린다.</p>

<p>fail2ban 적용을 위한 로그와 공통 설정파일을 밖으로 빼고<br />
tomcat 에는 label만 잘 맞춰준다.</p>

<p>ratelimit은 앞으로의 사용을 고려해 조절해야하는데<br />
우선 테스트를 위해 일반적인 웹 요청에 적당한 값으로 세팅했다.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">networks</span><span class="pi">:</span>
  <span class="na">proxy</span><span class="pi">:</span>
    <span class="na">external</span><span class="pi">:</span> <span class="kc">false</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">traefik</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">traefik:3.5.2</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">networks</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">proxy</span><span class="pi">]</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">443:443"</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">--entrypoints.web.address=:80</span>
      <span class="pi">-</span> <span class="s">--entrypoints.websecure.address=:443</span>
      <span class="pi">-</span> <span class="s">--entrypoints.web.http.redirections.entryPoint.to=websecure</span>
      <span class="pi">-</span> <span class="s">--entrypoints.web.http.redirections.entryPoint.scheme=https</span>
      <span class="pi">-</span> <span class="s">--providers.docker=true</span>                    <span class="c1"># 도커 레이블로 라우팅/미들웨어 정의</span>
      <span class="pi">-</span> <span class="s">--providers.docker.exposedbydefault=false</span>  <span class="c1"># 레이블에 enable=true 있는 컨테이너만 공개</span>
      <span class="pi">-</span> <span class="s">--providers.file.directory=/dynamic</span>
      <span class="pi">-</span> <span class="s">--certificatesresolvers.le.acme.tlschallenge=true</span>
      <span class="pi">-</span> <span class="s">--certificatesresolvers.le.acme.email=id@mail.com</span>
      <span class="pi">-</span> <span class="s">--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json</span>
      <span class="pi">-</span> <span class="s">--accesslog=true</span>
      <span class="pi">-</span> <span class="s">--accesslog.filepath=/var/log/traefik/access.log</span>
      <span class="pi">-</span> <span class="s">--log.level=INFO</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock:ro</span>
      <span class="pi">-</span> <span class="s">./letsencrypt:/letsencrypt</span>
      <span class="pi">-</span> <span class="s">./logs/traefik:/var/log/traefik</span>  <span class="c1"># fail2ban 위한 로그</span>
      <span class="pi">-</span> <span class="s">./dynamic:/dynamic:ro</span> 
    <span class="na">security_opt</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">no-new-privileges:true</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik.enable=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.middlewares.sec-headers.headers.stsSeconds=300</span>               <span class="c1"># HSTS 테스트용 5분</span>
      <span class="pi">-</span> <span class="s">traefik.http.middlewares.sec-headers.headers.stsIncludeSubdomains=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.middlewares.sec-headers.headers.stsPreload=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.middlewares.sec-headers.headers.contentTypeNosniff=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.middlewares.sec-headers.headers.frameDeny=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.middlewares.ratelimit.ratelimit.average=20</span>  <span class="c1"># 초당 평균 허용 요청수</span>
      <span class="pi">-</span> <span class="s">traefik.http.middlewares.ratelimit.ratelimit.burst=40</span>    <span class="c1"># 버스트</span>

  <span class="na">tomcat</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">tomcat:10-jdk17-corretto</span>   <span class="c1"># 테스트용 Tomcat 10</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">networks</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">proxy</span><span class="pi">]</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik.enable=true</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.tomcat.rule=Host(`test.domain.io`)</span>       <span class="c1"># 도메인</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.tomcat.entrypoints=websecure</span>             <span class="c1"># HTTPS에서만 서비스</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.tomcat.tls.certresolver=le</span>               <span class="c1"># 위에서 정의한 ACME resolver</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.tomcat.tls.options=strict-tls@file</span>       <span class="c1"># 파일 프로바이더의 TLS 정책</span>
      <span class="pi">-</span> <span class="s">traefik.http.routers.tomcat.middlewares=sec-headers,ratelimit</span> <span class="c1"># 공통 미들웨어</span>
      <span class="pi">-</span> <span class="s">traefik.http.services.tomcat.loadbalancer.server.port=8080</span>    <span class="c1"># 컨테이너 내부 포트</span>
</code></pre></div></div>

<p>추후 서브 도메인만 변경해 다른 앱을 올릴 경우<br />
서비스 레이블에 다른 도메인을 세팅해주면 해당 도메인으로 인증서를 발급받아준다.</p>

<h5 id="2-기동">2. 기동</h5>

<p><img src="/assets/images/posts/Server/WEB/2025-09-15-Setting Traefik/img02.webp" alt="img02" /></p>

<p><img src="/assets/images/posts/Server/WEB/2025-09-15-Setting Traefik/img03.webp" alt="img03" /></p>

<p><span style="color: orange;"><strong>docker compose up -d</strong></span> 명령어로 기동한다.<br />
정상적으로 컨테이너가 올라간 것을 보고 docker logs 명령어로 오류가 없는지 확인한다.<br />
로그가 전부 INFO 레벨인걸 보니 이상이 없어보인다.</p>

<p>브라우저로 접근해보자.</p>

<p><img src="/assets/images/posts/Server/WEB/2025-09-15-Setting Traefik/img04.webp" alt="img04" /></p>

<p>TLS 인증서가 적용되어있고, 404 페이지가 뜬다.<br />
깡통 톰캣 컨테이너에 아무것도 들어있지 않아 404가 뜨는거라 정상적인 접근이다.</p>

<h5 id="3-fail2ban-연동">3. fail2ban 연동</h5>

<p>필터를 새롭게 설정하여 fail2ban 연동을 진행한다.<br />
이 부분 또한 실제 사용에 따라 세부 설정이 필요한데<br />
우선은 테스트로 적당히 값 집어넣어서 설정한다.</p>

<p><span style="color: orange;"><strong>429, 404, 시그니처 스캔 필터</strong></span> 3가지를 만든다.<br />
429는 traefik이 429 Too Many Requests로 거른 요청들을 차단하고<br />
시그니처 스캔 필터는 /.git /wp-login.php 등 잘 알려진 취약점이나 관리 페이지 경로를 차단한다.</p>

<p>추후 모든 요청(성공 포함)이나 봇 요청에 대한 필터를 추가할 수 있겠다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/fail2ban/jail.d/traefik-access.conf</span>
  
<span class="o">[</span>DEFAULT]
action <span class="o">=</span> ufw
logpath <span class="o">=</span> /app/logs/traefik/access.log
backend <span class="o">=</span> auto

<span class="o">[</span>traefik-rate-429]
enabled  <span class="o">=</span> <span class="nb">true
</span>filter   <span class="o">=</span> traefik-rate-429
maxretry <span class="o">=</span> 5
findtime <span class="o">=</span> 60
bantime  <span class="o">=</span> 3600

<span class="o">[</span>traefik-rate-404]
enabled  <span class="o">=</span> <span class="nb">true
</span>filter   <span class="o">=</span> traefik-rate-404
maxretry <span class="o">=</span> 10
findtime <span class="o">=</span> 600
bantime  <span class="o">=</span> 3600

<span class="o">[</span>traefik-scan]
enabled  <span class="o">=</span> <span class="nb">true
</span>filter   <span class="o">=</span> traefik-scan
findtime <span class="o">=</span> 600
maxretry <span class="o">=</span> 3
bantime  <span class="o">=</span> <span class="nt">-1</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/fail2ban/filter.d/traefik-rate-429.conf</span>
<span class="o">[</span>Definition]
failregex <span class="o">=</span> ^&lt;HOST&gt; .<span class="k">*</span> <span class="s2">".*"</span> 429 .<span class="k">*</span>
ignoreregex <span class="o">=</span>

<span class="c"># /etc/fail2ban/filter.d/traefik-rate-404.conf</span>
<span class="o">[</span>Definition]
failregex <span class="o">=</span> ^&lt;HOST&gt; .<span class="k">*</span> <span class="s2">".*"</span> 404 .<span class="k">*</span>
ignoreregex <span class="o">=</span>

<span class="c"># /etc/fail2ban/filter.d/traefik-scan.conf</span>
<span class="o">[</span>Definition]
failregex <span class="o">=</span> ^&lt;HOST&gt; .<span class="k">*</span> <span class="s2">"(GET|POST|HEAD) .*(/wp-login</span><span class="se">\.</span><span class="s2">php|/wp-admin|/xmlrpc</span><span class="se">\.</span><span class="s2">php|/phpmyadmin|/pma/|/vendor/phpunit|/</span><span class="se">\.</span><span class="s2">env|/</span><span class="se">\.</span><span class="s2">git/|/server-status|/actuator|/manager/html|/jmx-console|/HNAP1|/boaform|/config</span><span class="se">\.</span><span class="s2">json|/id_rsa|/adminer</span><span class="se">\.</span><span class="s2">php|/shell</span><span class="se">\.</span><span class="s2">php)"</span> .<span class="k">*</span>
ignoreregex <span class="o">=</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/Server/WEB/2025-09-15-Setting Traefik/img05.webp" alt="img05" /></p>

<p>fail2ban을 재기동하여 필터를 확인한다.<br />
현재는 tomcat 깡통이 전부 404 Not Found로 빠지기 때문에 404 필터에 실패 요청이 쌓여있다.</p>

<h5 id="4-로그-분리">4. 로그 분리</h5>

<p>access.log는 한 파일에 계속해서 쌓이기 때문에 분리할 필요가 있다.<br />
fail2ban이 놓치지 않게 copytruncate 방식으로 logrotate 규칙을 설정한다.</p>

<p>오래된 RHEL 계열 서버에서는 따로 crontab 등록했던 거 같은데…<br />
요즘엔 알아서 돌려주나보다.<br />
편하다 편해.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/logrotate.d/traefik</span>

/app/logs/traefik/access.log <span class="o">{</span>
  daily
  rotate 30
  compress
  delaycompress
  missingok
  copytruncate
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <h4 id="꼬리말">꼬리말</h4>
  <hr />
</blockquote>

<p>traefik 설정이 굉장히 쉽고 간편해서 빠르게 끝났다.<br />
nginx 쓸때는 100% 에러 뿜뿜하고 트러블슈팅 들어가야할텐데 말이다.</p>

<p>언젠가 cloudflare 의존 없이 직접 제어해야할 상황이 온다면 본격적으로 traefik을 사용해볼 것 같다.<br />
첫 인상이 아주 좋다.</p>]]></content><author><name>movingwoo</name></author><category term="Server/WEB/" /><category term="SERVER" /><category term="WEB" /><category term="도커" /><category term="구축" /><category term="설정" /><category term="TRAEFIK" /><summary type="html"><![CDATA[Traefik 첫 구축, 설정]]></summary></entry><entry><title type="html">3호기 서버 설정</title><link href="https://movingwoo.com/server/2025/09/12/Server-MK3-Setting.html" rel="alternate" type="text/html" title="3호기 서버 설정" /><published>2025-09-12T02:00:00+00:00</published><updated>2025-09-15T04:00:00+00:00</updated><id>https://movingwoo.com/server/2025/09/12/Server%20MK3%20Setting</id><content type="html" xml:base="https://movingwoo.com/server/2025/09/12/Server-MK3-Setting.html"><![CDATA[<blockquote>
  <h4 id="이어서">이어서</h4>
  <hr />
</blockquote>

<p>생각해보니 램 얼만지 확인을 안해봤다.</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img01.webp" alt="img01" /></p>

<p>아니 무슨 40기가나 박혀있네?<br />
내 게임 PC가 32기가일텐데…</p>

<blockquote>
  <h4 id="설정할-내용">설정할 내용</h4>
  <hr />
</blockquote>

<p>계정을 여러개 쓰지 않을거라 돌이킬 수 없는 결과를 낳을 듯한 faillock은 제외하고 간단하게 4가지를 설정한다.</p>
<ul>
  <li><span style="color: orange;"><strong>root 로그인 비활성화</strong></span></li>
  <li><span style="color: orange;"><strong>ssh 포트 변경</strong></span></li>
  <li><span style="color: orange;"><strong>fail2ban</strong></span></li>
  <li><span style="color: orange;"><strong>세션 타임아웃</strong></span></li>
</ul>

<p>그 외 설정으로 bash 프롬프트 수정과 히스토리 최적화 등을 진행한다.</p>

<blockquote>
  <h4 id="설정">설정</h4>
  <hr />
</blockquote>

<h5 id="1-업그레이드">1. 업그레이드</h5>

<p>22.04로 설치했으니 24.04로 업그레이드를 우선 진행한다.<br />
이것저것 설치되어 있을수록 업그레이드가 부담되니까 깡통일때 해버리는게 낫다.</p>

<p><span style="color: orange;"><strong>sudo do-release-upgrade</strong></span><br />
명령어 입력 후 콘솔 안내에 따라 업그레이드를 진행한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img02.webp" alt="img02" /></p>

<p>업그레이드 중 언어셋이 en_US.UTF-8 인걸 확인했다.<br />
데스크탑 설치에는 한국어 설정이 있었는데 서버 설치에는 없어서 전체 영어로 진행되는 상황.<br />
ko_KR.UTF-8 로 바꿔줘야겠다.</p>

<p><span style="color: orange;"><strong>sudo apt install language-pack-ko</strong></span><br />
<span style="color: orange;"><strong>sudo update-locale LANG=ko_KR.UTF-8</strong></span></p>

<p>언어팩을 설치하고 locale을 바꿔준다.</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img03.webp" alt="img03" /></p>

<p>안내문이 한글로 뜨는 것을 볼 수 있다.</p>

<h5 id="2-sshd-설정">2. sshd 설정</h5>

<p><span style="color: orange;"><strong>/etc/ssh/sshd_config</strong></span> 파일을 수정하면<br />
ssh 포트 변경, root 로그인 차단을 처리할 수 있다.<br />
추가로 네트워크 응답이 없으면 끊기게 시간제한도 설정한다.</p>

<p>사실 포트 변경과 루트 차단은 굳이 설정할 필요가 없다.<br />
22번 포트는 앞단에서 포트 포워딩을 하기 때문에 직접 노출되지 않고<br />
우분투는 설치 시 생성하는 계정에 sudo 권한을 주고 root 계정을 바로 사용하지 않기 때문에 어차피 로그인이 안된다.<br />
그래도 기분 문제가 있으니 변경하기로 한다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/ssh/sshd_config</span>

Port 12345                <span class="c"># 포트</span>
PermitRootLogin no        <span class="c"># 루트 로그인 비허용</span>
ClientAliveInterval 300   <span class="c"># 종료대기 시간(s)</span>
ClientAliveCountMax 0     <span class="c"># 실패 횟수</span>
</code></pre></div></div>

<p>아직 서버 접근할 고정적인 환경이 정해지지 않은 상태라 인증서 로그인 설정은 생략한다.</p>

<h5 id="3-fail2ban">3. fail2ban</h5>

<p>fail2ban은 로그 파일을 모니터링해서 이상 로그인 패턴을 찾아 차단하는 도구이다.<br />
<span style="color: orange;"><strong>sudo apt install fail2ban</strong></span> 명령어로 설치한다.</p>

<p><span style="color: orange;"><strong>/etc/fail2ban/jail.conf</strong></span> 파일이 설정파일인데<br />
개인 설정을 위해 복사해서 <span style="color: orange;"><strong>jail.local</strong></span> 파일을 만들고 sshd 블럭을 찾아 수정한다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/fail2ban/jail.local</span>

<span class="o">[</span>sshd]
enabled   <span class="o">=</span> <span class="nb">true                          
</span>port      <span class="o">=</span> 12345             <span class="c"># ssh 포트</span>
filter    <span class="o">=</span> sshd
logpath   <span class="o">=</span> %<span class="o">(</span>sshd_log<span class="o">)</span>s
backend   <span class="o">=</span> %<span class="o">(</span>sshd_backend<span class="o">)</span>s
banaction <span class="o">=</span> ufw               <span class="c"># ufw 사용</span>
maxretry  <span class="o">=</span> 5                 <span class="c"># 시도 횟수</span>
bantime   <span class="o">=</span> <span class="nt">-1</span>                <span class="c"># 영구밴</span>
findtime  <span class="o">=</span> 600               <span class="c"># 지정한 시간 내 탐색</span>
ignoreip  <span class="o">=</span> 127.0.0.1/8       <span class="c"># 허용 IP</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img06.webp" alt="img06" /></p>

<p>설정 후 fail2ban 재시작하고 일부러 패스워드를 틀려본다.</p>

<p><span style="color: orange;"><strong>sudo fail2ban-client status sshd</strong></span><br />
명령어 입력 시 사진과 같이 잘못된 로그인을 탐지한 것을 볼 수 있다.</p>

<h5 id="4-bash-설정">4. bash 설정</h5>

<p><span style="color: orange;"><strong>.bashrc</strong></span> 파일을 수정해서 idle logout과 프롬프트, 히스토리를 수정한다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># idle logout</span>
<span class="nb">export </span><span class="nv">TIMEOUT</span><span class="o">=</span>300

<span class="c"># prompt</span>
<span class="nb">export </span><span class="nv">PS1</span><span class="o">=</span><span class="s1">'\w\$ '</span>

<span class="c"># edit history</span>
<span class="nb">export </span><span class="nv">HISTSIZE</span><span class="o">=</span>50000
<span class="nb">export </span><span class="nv">HISTFILESIZE</span><span class="o">=</span>100000
<span class="nb">export </span><span class="nv">HISTCONTROL</span><span class="o">=</span>ignoredups:erasedups:ignorespace
<span class="nb">export </span><span class="nv">HISTTIMEFORMAT</span><span class="o">=</span><span class="s1">'%F %T '</span>
<span class="nb">shopt</span> <span class="nt">-s</span> histappend
<span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s1">'history -a; history -n; '</span><span class="s2">"</span><span class="nv">$PROMPT_COMMAND</span><span class="s2">"</span>
</code></pre></div></div>

<p>프롬프트에는 계정과 호스트를 빼고 경로만 남긴다.<br />
히스토리를 정리하지 않으면 기본적으로</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img04.webp" alt="img04" /></p>

<p>이렇게 나오는데<br />
중복제거, 타임스탬프 추가 등 작업을 통해 아래와 같이 깔끔하게 정리할 수 있다.</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img05.webp" alt="img05" /></p>

<h5 id="5-도커-설치">5. 도커 설치</h5>

<p>아 도커는 필수 툴이지.<br />
작업 PC 환경은 로키 리눅스를 사용하는데 우분투는 또 설치방법이 조금 다르다.<br />
조금 더 길다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 필수 패키지 확인</span>
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> ca-certificates curl gnupg

<span class="c"># gpg 키 및 repo 등록</span>
<span class="nb">sudo install</span> <span class="nt">-m</span> 0755 <span class="nt">-d</span> /etc/apt/keyrings
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/docker.gpg
<span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null

<span class="c"># 설치</span>
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

<span class="c"># 실행, 권한부여</span>
<span class="nb">sudo </span>systemctl <span class="nb">enable</span> <span class="nt">--now</span> docker
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img07.webp" alt="img07" /></p>

<p>정상적으로 서비스 올라온 것을 확인하면 끝.</p>

<h5 id="6-공지-수정">6. 공지 수정</h5>

<p>서버 계정 로그인 시 공지가 뜬다.<br />
버전 정보나 간단한 안내문, 업데이트 관련 정보가 노출이 되는데 대부분 필요없다.</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img08.webp" alt="img08" /></p>

<p>현재 정보에서 시스템 정보, 업데이트 가능 여부, 마지막 로그인 3가지 정보만 남기고 다 지워보자.</p>

<p><span style="color: orange;"><strong>/etc/update-motd.d</strong></span> 경로로 들어가면 공지 관련 파일들이 있다.<br />
파일들은 숫자 순서로 실행된다.</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img09.webp" alt="img09" /></p>

<p>마지막 로그인은 PAM 에서 출력하니 상관없다.<br />
파일들을 확인해서 보여주지 않을 내용이 있는 파일에 대한 실행 권한을 제거한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img10.webp" alt="img10" /></p>

<p>이후 로그인 해보면 공지가 상당수 줄어든 것을 볼 수 있다.</p>

<p><img src="/assets/images/posts/Server/2025-09-12-Server MK3 Setting/img11.webp" alt="img11" /></p>

<p>ESM 메시지는 업데이트 메시지에 딸려오는거 같은데…<br />
수동 제거하거나 커스텀해야하는데 귀찮으니 당분간 냅두자.<br />
근데 뭐했다고 온도가 60도가 넘지?</p>

<blockquote>
  <h4 id="마무리">마무리</h4>
  <hr />
</blockquote>

<p>금방 설정하고 끝날 줄 알았는데 생각보다 이것도 해야지 저것도 해야지 하다보니 바빠졌다.</p>

<p>분명 또 빼먹은게 있을테니 쉬면서 생각나면 추가로 진행하고 서비스 올려봐야겠다.</p>]]></content><author><name>movingwoo</name></author><category term="Server/" /><category term="SERVER" /><category term="ubuntu" /><category term="구축" /><category term="설정" /><summary type="html"><![CDATA[3호기 개인 우분투 서버 설정]]></summary></entry><entry><title type="html">3호기 서버 구축</title><link href="https://movingwoo.com/server/2025/09/11/Build-Server-MK3.html" rel="alternate" type="text/html" title="3호기 서버 구축" /><published>2025-09-11T02:00:00+00:00</published><updated>2025-09-11T02:00:00+00:00</updated><id>https://movingwoo.com/server/2025/09/11/Build%20Server%20MK3</id><content type="html" xml:base="https://movingwoo.com/server/2025/09/11/Build-Server-MK3.html"><![CDATA[<blockquote>
  <h4 id="들어가기-앞서">들어가기 앞서</h4>
  <hr />
</blockquote>

<p>서버 1호기와 2호기를 운영 중 이상이 생겼다.</p>

<p>1호기는 서피스 윈도우를 밀어버리고 우분투를 올렸는데<br />
뭐가 문제인지 며칠 지나면 멋대로 <span style="color: red;"><strong>‘죽을게’</strong></span>를 외치고 꺼져버린다.<br />
왜 이러는거야…</p>

<p>2호기는 오라클 클라우드에서 40평형 궁궐같은 집을 무료로 임대받아 살았는데<br />
리전이 한국이 아니라 일본이라 사소한 이슈가 조금 있었고<br />
이를 해결하기 위한 오라클과의 불통 끝에 서버 접근도 안되고 탈퇴도 안되는 불법체류자 같은 존재가 되었다.</p>

<p>3호기 서버가 절실한 상황, 서버를 새로 구축한다.</p>

<blockquote>
  <h4 id="3호기-설계">3호기 설계</h4>
  <hr />
</blockquote>

<p>무료로 제공하는 VM 서비스를 찾아보면, 사실 오라클 클라우드를 제외하면 마땅한 후보가 존재치 않는다.<br />
기간 제한이 있거나 용량이 너무 적다.<br />
돈 만원이라도 넣어야 사용할만한 공간이 나오는데 무료가 아니라 아쉬운게 사실.</p>

<p>결국 물리 서버 하나 집구석에 던져두고 공유기 물려두는게 제일 저렴하다.<br />
3호기에 서비스를 올려서 테스트용으로 가볍게 사용할거라 네트워크 이슈가 생길 일도 없다.</p>

<p>다행히도 뽀얗게 먼지쌓인 데스크탑 한 대가 있다.</p>

<p>뭔가 램도 꽂혀있고 그래픽카드도 달려있는데… 모델 명을 모르겠다.<br />
6 ~ 7년은 지난 터라 구매기록도 못찾겠다.</p>

<p>다른 부품은 다 있고 SSD만 뽑아간 탓에 SSD 연결하면 사용에는 이상이 없을 것 같다.<br />
M.2 슬롯이 없는 것 같으니 SATA SSD 500gb 로 주문하자.</p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img01.webp" alt="img01" /></p>

<p>배송비 포함 8만원<br />
PC 부품이 워낙 싯가로 널뛰기를 하기 때문에 싼지 비싼지 가늠이 안간다.<br />
쓸 돈은 써야지 뭐…</p>

<blockquote>
  <h4 id="3호기-구축">3호기 구축</h4>
  <hr />
</blockquote>

<h5 id="1-본체-확인">1. 본체 확인</h5>

<p>나는 하드웨어 쪽은 잘 모르지만, PC 조립은 레고의 그것과 같다고 들었다.</p>

<p><span style="color: orange;"><strong>구멍이 맞는가?</strong></span><br />
<span style="color: orange;"><strong>큰 힘 없이 끼워지는가?</strong></span><br />
<span style="color: red;"><strong>거기가 맞으니 끼워라</strong></span></p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img02.webp" alt="img02" /></p>

<p>이렇게 하면 되겠지?<br />
대충 남는 공간에 쑤셔박고 파워를 물리면 끝</p>

<h5 id="2-부팅-디스크-준비">2. 부팅 디스크 준비</h5>

<p><span style="color: orange;"><strong>rufus</strong></span>를 이용하여 usb를 부팅디스크로 만든다.<br />
ventoy 였나? 그걸 쓰는 경우도 있다는데 나는 익숙한 rufus를 쓰기로 했다.</p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img03.webp" alt="img03" /></p>

<p><a href="https://ubuntu.com/download/server">Ubuntu Server Download</a></p>

<p>공식홈페이지에서 다운로드 받아 부팅 드라이브를 만든다.</p>

<p>여기서 <span style="color: orange;"><strong>우분투 데스크탑</strong></span>을 사용할지, <span style="color: orange;"><strong>우분투 서버</strong></span>를 사용할지 결정을 해야하는데 나는 서버를 선택했다.<br />
모니터와 키보드 없이 전원만 붙여놓을 생각이기 때문이며, 서버는 인터넷 없는 환경에서 <span style="color: orange;"><strong>OpenSSH를 사전 설치</strong></span> 가능하다.<br />
우선 인터넷 없는 환경에서 설치 후 자리를 옮길거라 서버가 적절한 옵션이다.</p>

<p>데스크탑과 서버의 차이는 대략 아래와 같다.</p>

<table>
  <thead>
    <tr>
      <th>항목</th>
      <th>Ubuntu Desktop</th>
      <th>Ubuntu Server</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>GUI</strong></td>
      <td>O</td>
      <td>X</td>
    </tr>
    <tr>
      <td><strong>기본 설치 패키지</strong></td>
      <td>파폭, 리브레오피스 등</td>
      <td>openssh, apache 등</td>
    </tr>
    <tr>
      <td><strong>자원 사용량</strong></td>
      <td>상대적으로 무거움</td>
      <td>상대적으로 가벼움</td>
    </tr>
    <tr>
      <td><strong>보안 정책</strong></td>
      <td>개인 사용자 보안 중심 (방화벽 off 기본)</td>
      <td>서버 보안 중심 (SSH 접근, UFW 설정 등 적극 권장)</td>
    </tr>
    <tr>
      <td><strong>업데이트 주기</strong></td>
      <td>데스크탑 중심 패키지 포함 (예: 그래픽 드라이버, 오피스 등)</td>
      <td>서버 안정성·장기 지원 중심 (서비스 지향)</td>
    </tr>
  </tbody>
</table>

<p>초기화 시 iso로 할지 dd로 할지 묻는데 <span style="color: orange;"><strong>dd</strong></span>로 진행하면 된다.<br />
일부 환경에서 iso usb가 인식이 잘 안될수도 있다고, 그대로 복제를 한 dd 이미지가 안정적이라고 한다.</p>

<h5 id="3-os-설치">3. OS 설치</h5>

<p>usb로 부팅 후 하라는 대로 엔터치면서 설치하면 끝인데…<br />
여기서 한가지 문제 발생<br />
<span style="color: red;"><strong>The install media checksum verification failed</strong></span> 라는 오류가 뜨며 진행할 수 없다.</p>

<p>일반적으로 usb를 잘못 구웠거나 다운로드가 잘못되었을 경우 발생한다는데…<br />
하드웨어가 잘못되었을 가능성도 있기 때문에 데스크탑 버전으로 한 번 설치를 시도한다.<br />
결과는 성공.</p>

<p>데스크탑 설치는 문제없으니 하드웨어 이상은 아닐거로 판단, 하위버전을 설치해본다.<br />
24.04 말고 22.04 버전으로 새로 다운로드 받아서 설치하니 성공.</p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img04.webp" alt="img04" /></p>

<p><strong>acquiring and extracting image</strong> 부분에서 오류 발생 후 셧다운 됐었는데<br />
이상없이 시스템 설치가 진행된다.</p>

<h5 id="4-세팅">4. 세팅</h5>

<p>인터넷이 연결되면 우선 업데이트를 진행한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img05.webp" alt="img05" /></p>

<p>시간대 설정 후 ufw에 ssh 포트를 세팅한다.</p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img06.webp" alt="img06" /></p>

<p>보안 상 22번 포트를 그대로 노출하는건 별로다.<br />
추후 22번 포트 자체를 다른 포트로 변경할텐데 우선은 공유기 포트 포워딩 설정에서 외부 포트를 다른 포트로 지정하고 내부 22번 포트로 연결한다.</p>

<p>ssh 접속 테스트 진행</p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img07.webp" alt="img07" /></p>

<p>이제 연결해둔 모니터와 키보드를 제거하고 전원만 켜두면 된다.</p>

<blockquote>
  <h4 id="앞으로-해야할-것">앞으로 해야할 것</h4>
  <hr />
</blockquote>

<p>오랜만에 서버 구축하니까 재미있다.</p>

<p>24.04로 업그레이드는 당장 필요치 않으니 제외하고<br />
<span style="color: orange;"><strong>보안 설정</strong></span>을 우선적으로 진행하고<br />
도커와 같은 필수 툴을 설치하고<br />
개인 설정을 진행해야한다.</p>

<p>그러고보니 보드가 뭔지 그래픽카드는 뭔지 정보를 아무것도 모르고 일단 올렸는데 이제 확인해보자.</p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img08.webp" alt="img08" /><br />
<img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img09.webp" alt="img09" /><br />
<img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img10.webp" alt="img10" /></p>

<p>그래픽카드의 경우 명확히는 안나오는데 아마 기억이 맞다면 rx 570쯤 될거다.<br />
이 서버엔 너무나 과분한 그래픽카드가 아닐 수 없다.</p>

<p>메인보드가 MSI B450M 인데…</p>

<p><img src="/assets/images/posts/Server/2025-09-11-Build Server MK3/img11.webp" alt="img11" /></p>

<p><span style="color: red;"><strong>뭐야 M.2 슬롯이 있었다고?</strong></span></p>]]></content><author><name>movingwoo</name></author><category term="Server/" /><category term="SERVER" /><category term="ubuntu" /><category term="구축" /><summary type="html"><![CDATA[3호기 개인 우분투 서버 구축]]></summary></entry><entry><title type="html">마리아디비 설치</title><link href="https://movingwoo.com/development/shellscript/2025/08/04/Install-MariaDB.html" rel="alternate" type="text/html" title="마리아디비 설치" /><published>2025-08-04T07:00:00+00:00</published><updated>2025-08-04T07:00:00+00:00</updated><id>https://movingwoo.com/development/shellscript/2025/08/04/Install%20MariaDB</id><content type="html" xml:base="https://movingwoo.com/development/shellscript/2025/08/04/Install-MariaDB.html"><![CDATA[<blockquote>
  <h4 id="개요">개요</h4>
  <hr />
</blockquote>

<p>일반적인 리눅스 환경에서 마리아디비 설치가 필요한 경우 rpm으로 설치한다.<br />
간편하고 빠르다.</p>

<p>하지만 rpm을 쓸 수 없는 특수한 환경에서는 어떡하지?<br />
구글링하면서 공부하다가 자동화 스크립트 만들 수 있을 것 같아서 만든다.</p>

<blockquote>
  <h4 id="설계">설계</h4>
  <hr />
</blockquote>

<p><a href="https://mariadb.org/download/">MariaDB Foundation Download</a></p>

<p>설치할 마리아디비 tarball 파일은 공식홈페이지에서 구할 수 있다.</p>

<p>tar 파일 이용해 설치 진행 시 내용을 간단히 요약해보자면</p>
<ol>
  <li><span style="color: orange;"><strong>파일들을 적당히 경로로 옮긴다.</strong></span></li>
  <li><span style="color: orange;"><strong>데이터베이스 초기화 스크립트를 수행한다.</strong></span></li>
  <li><span style="color: orange;"><strong>기동!!</strong></span></li>
</ol>

<p>써놓고 보면 아주 단순한데 막상 해보면 이상한 오류가 나기도 하고<br />
알 수 없는 억까의 세계</p>

<p>일단 커맨드 자체는 아주 단순한 편들이라 스크립트화 가능하다.</p>

<blockquote>
  <h4 id="구현">구현</h4>
  <hr />
</blockquote>

<h5 id="1-환경변수와-사용법-함수">1. 환경변수와 사용법 함수</h5>

<p>rpm으로 설치해보면 <span style="color: orange;"><strong>mysql</strong></span> 계정이 디폴트다.<br />
다른 계정을 쓸 수 있으니 그룹과 계정을 변수로 뺀다.</p>

<p><span style="color: orange;"><strong>TAR</strong></span> 파일 경로는 당연히 옵션화 해야하며<br />
<span style="color: orange;"><strong>/usr/local</strong></span> 하위 설치를 디폴트로 두고 변수화한다.</p>

<p>사용 시 설치를 리트라이할 수 있는데 이때를 위해 데이터를 삭제하는 옵션을 넣어준다.<br />
<span style="color: orange;"><strong>RESET</strong></span> 옵션은 삭제 후 재설치, <span style="color: orange;"><strong>CLEAN</strong></span> 옵션은 삭제만 하는 것으로 한다.</p>

<p>그냥 스크립트 호출하는 순간 설치가 진행되는 것도 위험하기 때문에 <span style="color: orange;"><strong>INSTALL</strong></span> 옵션을 넣어준다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 기본 변수</span>
<span class="nv">GROUP</span><span class="o">=</span><span class="s2">"mysql"</span>
<span class="nv">USER</span><span class="o">=</span><span class="s2">"mysql"</span>
<span class="nv">TAR_FILE</span><span class="o">=</span><span class="s2">"/home/app/mariadb-10.11.13-linux-systemd-x86_64.tar.gz"</span>
<span class="nv">INSTALL_PREFIX</span><span class="o">=</span><span class="s2">"/usr/local"</span>
<span class="nv">INSTALL_DIR</span><span class="o">=</span><span class="s2">"</span><span class="nv">$INSTALL_PREFIX</span><span class="s2">/mariadb"</span>
<span class="nv">RESET</span><span class="o">=</span><span class="nb">false
</span><span class="nv">CLEAN_ONLY</span><span class="o">=</span><span class="nb">false
</span><span class="nv">INSTALL</span><span class="o">=</span><span class="nb">false</span>

<span class="c"># 옵션 파싱</span>
<span class="k">while</span> <span class="o">[[</span> <span class="nv">$# </span><span class="nt">-gt</span> 0 <span class="o">]]</span><span class="p">;</span> <span class="k">do
  case</span> <span class="nv">$1</span> <span class="k">in</span>
    <span class="nt">-i</span><span class="p">|</span><span class="nt">--install</span><span class="p">)</span>    <span class="nv">INSTALL</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span> <span class="nb">shift</span><span class="p">;;</span>
    <span class="nt">-r</span><span class="p">|</span><span class="nt">--reset</span><span class="p">)</span>      <span class="nv">RESET</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span> <span class="nb">shift</span><span class="p">;;</span>
    <span class="nt">-c</span><span class="p">|</span><span class="nt">--clean</span><span class="p">)</span>      <span class="nv">CLEAN_ONLY</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span> <span class="nb">shift</span><span class="p">;;</span>
    <span class="nt">-h</span><span class="p">|</span><span class="nt">--help</span><span class="p">)</span>       usage<span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>               <span class="nb">echo</span> <span class="s2">"Unknown option: </span><span class="nv">$1</span><span class="s2">"</span> <span class="o">&gt;</span>&amp;2<span class="p">;</span> usage<span class="p">;;</span>
  <span class="k">esac</span>
<span class="k">done</span>
</code></pre></div></div>

<p>옵션 없이 스크립트를 호출하거나, -h 옵션을 넣을 경우에는 도움말을 보여주도록 한다.<br />
<span style="color: red;"><strong>이런 거 무시하고 안넣으면 나중에 나도 까먹어서 사용할 수 없다…</strong></span></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 사용법 함수</span>
usage<span class="o">()</span> <span class="o">{</span>
  <span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
Usage: sudo </span><span class="nv">$0</span><span class="sh"> [options]

Options:
  -i, --install     Install MariaDB
                    마리아디비 설치
  -r, --reset       Reset data before installing (remove then reinstall)
                    데이터 초기화 후 설치 (삭제 후 재설치)
  -c, --clean       Clean only (remove data without reinstalling)
                    초기화만 (재설치 없이 삭제)
  -h, --help        Show this help message and exit
                    도움말
</span><span class="no">EOF
</span>  <span class="nb">exit </span>1
<span class="o">}</span>
</code></pre></div></div>

<h5 id="2-설치-전-조건과-초기화-조건">2. 설치 전 조건과 초기화 조건</h5>

<p>관리자 권한이 필요해 <span style="color: orange;"><strong>root 권한</strong></span>을 체크한다.<br />
RESET 옵션과 CLEAN 옵션이 충돌하면 난리날거라 그 부분도 확인하고<br />
CLEAN을 지정했을 경우 삭제 후 프로세스를 종료하도록 설정한다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># root 권한 확인</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"[ERROR] root 권한으로 실행해야 함"</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># -r 과 -c 충돌 확인</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$RESET</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$CLEAN_ONLY</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"[ERROR] -r 과 -c 옵션은 함께 사용 불가"</span> <span class="o">&gt;</span>&amp;2
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># 아무 옵션도 안걸면 -h로 수행</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$INSTALL</span><span class="s2">"</span> <span class="o">!=</span> <span class="nb">true</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$RESET</span><span class="s2">"</span> <span class="o">!=</span> <span class="nb">true</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$CLEAN_ONLY</span><span class="s2">"</span> <span class="o">!=</span> <span class="nb">true</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>usage
<span class="k">fi</span>

<span class="c"># 초기화 (reset 또는 clean)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$RESET</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$CLEAN_ONLY</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"=== MariaDB 초기화 시작 ==="</span>
  systemctl stop mariadb <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> <span class="nb">true
  </span>systemctl disable mariadb <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> <span class="nb">true
  rm</span> <span class="nt">-f</span> /etc/systemd/system/mariadb.service
  systemctl daemon-reload <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">||</span> <span class="nb">true
  rm</span> <span class="nt">-rf</span> <span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">"</span>
  <span class="nb">rm</span> <span class="nt">-f</span> /etc/profile.d/mariadb.sh
  <span class="nb">rm</span> <span class="nt">-rf</span> <span class="s2">"</span><span class="nv">$INSTALL_PREFIX</span><span class="s2">/mysql"</span>
  <span class="nb">echo</span> <span class="s2">"=== 초기화 완료: 설치 디렉터리, 서비스 파일, 환경변수, 링크 제거 ==="</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$CLEAN_ONLY</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exit </span>0
  <span class="k">fi
fi</span>
</code></pre></div></div>

<h5 id="3-설치">3. 설치</h5>

<p>설치 커맨드를 나열하는 단계.</p>

<p>마리아디비가 마이에스큐엘의 아종이다보니 헷갈리는 부분이 많았다.<br />
mysql 이름의 폴더를 기본 설정으로 찾는 경우가 많아서 <span style="color: orange;"><strong>심볼릭 링크</strong></span>를 생성해 오류를 피하고<br />
<span style="color: orange;"><strong>데이터베이스 초기화 파일</strong></span>도 mariadb~~ 인 경우가 있고 mysql~~ 인 경우가 있어서 뭐라도 있으면 찾아서 쓰도록 하였다.</p>

<p>실제 이리저리 시도해보다 온갖 오류가 나길래 이 단계에서의 관건은 실패 시 해결책을 같이 써두는 것으로 하였다.<br />
<span style="color: orange;"><strong>ERROR</strong></span> 태그 출력 시 가능하면 <span style="color: orange;"><strong>HOW TO FIX</strong></span> 태그와 함께 수동으로 문제를 확인해볼 수 있게 한다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 설치</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$INSTALL</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$RESET</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>

  <span class="c"># 그룹/사용자 생성</span>
  getent group <span class="s2">"</span><span class="nv">$GROUP</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null <span class="o">||</span> groupadd <span class="s2">"</span><span class="nv">$GROUP</span><span class="s2">"</span>
  getent passwd <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null <span class="o">||</span> useradd <span class="nt">-r</span> <span class="nt">-g</span> <span class="s2">"</span><span class="nv">$GROUP</span><span class="s2">"</span> <span class="nt">-s</span> /bin/false <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span>

  <span class="c"># 압축 해제</span>
  <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$TAR_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"[ERROR] '</span><span class="nv">$TAR_FILE</span><span class="s2">' 파일을 찾을 수 없음"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"[HOW TO FIX] TAR_FILE 경로와 이름이 정확한지 확인."</span>
    <span class="nb">exit </span>1
  <span class="k">fi

  </span><span class="nb">echo</span> <span class="s2">"[INFO] '</span><span class="nv">$TAR_FILE</span><span class="s2">' 압축 해제 중..."</span>
  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$INSTALL_PREFIX</span><span class="s2">"</span>
  <span class="nb">tar</span> <span class="nt">-xzf</span> <span class="s2">"</span><span class="nv">$TAR_FILE</span><span class="s2">"</span> <span class="nt">-C</span> <span class="s2">"</span><span class="nv">$INSTALL_PREFIX</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="s2">"[SUCCESS] '</span><span class="nv">$INSTALL_PREFIX</span><span class="s2">' 아래 디렉터리 압축 해제 완료"</span>

  <span class="c"># 디렉터리 위치 조정</span>
  <span class="nv">EX_DIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">tar</span> <span class="nt">-tf</span> <span class="s2">"</span><span class="nv">$TAR_FILE</span><span class="s2">"</span> | <span class="nb">head</span> <span class="nt">-1</span> | <span class="nb">cut</span> <span class="nt">-f1</span> <span class="nt">-d</span><span class="s2">"/"</span><span class="si">)</span>
  <span class="nb">mv</span> <span class="s2">"</span><span class="nv">$INSTALL_PREFIX</span><span class="s2">/</span><span class="nv">$EX_DIR</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="s2">"[SUCCESS] '</span><span class="nv">$INSTALL_DIR</span><span class="s2">'로 이동 완료"</span>

  <span class="c"># 링크 생성</span>
  <span class="nb">ln</span> <span class="nt">-sfn</span> <span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$INSTALL_PREFIX</span><span class="s2">/mysql"</span>
  <span class="nb">echo</span> <span class="s2">"[SUCCESS] '</span><span class="nv">$INSTALL_PREFIX</span><span class="s2">/mysql' 심볼릭 링크 '</span><span class="nv">$INSTALL_DIR</span><span class="s2">' 생성 완료"</span>

  <span class="c"># 권한 설정</span>
  <span class="nb">cd</span> <span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">"</span>
  <span class="nb">mkdir</span> <span class="nt">-p</span> mysql-files data
  <span class="nb">chown</span> <span class="nt">-R</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span>:<span class="s2">"</span><span class="nv">$GROUP</span><span class="s2">"</span> <span class="nb">.</span>
  <span class="nb">chmod </span>750 mysql-files
  <span class="nb">echo</span> <span class="s2">"[SUCCESS] mysql-files, data 디렉터리 권한 변경 완료"</span>

  <span class="c"># 데이터베이스 초기화</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-x</span> <span class="s2">"bin/mariadb-install-db"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>bin/mariadb-install-db <span class="se">\</span>
      <span class="nt">--user</span><span class="o">=</span><span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span> <span class="se">\</span>
      <span class="nt">--basedir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">"</span> <span class="se">\</span>
      <span class="nt">--datadir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">/data"</span>
    <span class="nb">echo</span> <span class="s2">"[SUCCESS] bin/mariadb-install-db로 데이터베이스 초기화 완료"</span>

  <span class="k">elif</span> <span class="o">[</span> <span class="nt">-x</span> <span class="s2">"scripts/mysql_install_db"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>scripts/mysql_install_db <span class="se">\</span>
      <span class="nt">--user</span><span class="o">=</span><span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span> <span class="se">\</span>
      <span class="nt">--basedir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">"</span> <span class="se">\</span>
      <span class="nt">--datadir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">/data"</span>
    <span class="nb">echo</span> <span class="s2">"[SUCCESS] scripts/mysql_install_db로 데이터베이스 초기화 완료"</span>

  <span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"[ERROR] 초기화 스크립트를 찾을 수 없음, 수동 초기화 필요"</span> <span class="o">&gt;</span>&amp;2
    <span class="nb">echo</span> <span class="s2">"[HOW TO FIX]"</span>
    <span class="nb">echo</span> <span class="s2">"  1) </span><span class="nv">$INSTALL_DIR</span><span class="s2">/bin 또는 </span><span class="nv">$INSTALL_DIR</span><span class="s2">/scripts 경로 확인"</span>
    <span class="nb">echo</span> <span class="s2">"  2) 해당 경로에서 mysql_install_db 또는 mariadb-install-db 실행"</span>
    <span class="nb">echo</span> <span class="s2">"  3) 설정 완료 후 'systemctl start mariadb' 재시도"</span>
  <span class="k">fi</span>

  <span class="c"># 환경변수 등록</span>
  <span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/profile.d/mariadb.sh
export PATH=</span><span class="nv">$INSTALL_DIR</span><span class="sh">/bin:</span><span class="se">\$</span><span class="sh">PATH
</span><span class="no">EOF
</span>  <span class="nb">chmod</span> +x /etc/profile.d/mariadb.sh
  <span class="nb">echo</span> <span class="s2">"[SUCCESS] /etc/profile.d/mariadb.sh 생성 및 권한 변경 완료"</span>
<span class="k">fi</span>
</code></pre></div></div>

<h5 id="4-나머지-과정">4. 나머지 과정</h5>

<p>rpm으로 설치해보면 systemctl로 컨트롤 할 수 있게 올라간다.<br />
요즘에 <span style="color: orange;"><strong>systemd</strong></span> 안쓰는 리눅스가 어디있냐! 하느냐면<br />
당장 도커 컨테이너로 올리면 systemd 쓰기가 녹록치 않다.</p>

<p>때문에 분기로 systemd 여부를 체크하고 있으면 등록, 없으면 mysqld_safe 기동 후 크론탭에 자동 등록하도록 한다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># systemd 존재할 경우 서비스 설정 및 시작, 없으면 mysqld_safe 실행 후 크론 등록</span>
<span class="k">if </span><span class="nb">command</span> <span class="nt">-v</span> systemctl <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nt">-d</span> /run/systemd/system <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">IS_SYSTEMD</span><span class="o">=</span><span class="nb">true
</span><span class="k">else
  </span><span class="nv">IS_SYSTEMD</span><span class="o">=</span><span class="nb">false
</span><span class="k">fi

</span><span class="nv">SERVICE_SRC</span><span class="o">=</span><span class="si">$(</span>find <span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">"</span> <span class="nt">-type</span> f <span class="nt">-name</span> mariadb.service | <span class="nb">head</span> <span class="nt">-n1</span><span class="si">)</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$IS_SYSTEMD</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span><span class="p">;</span><span class="k">then
  if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$SERVICE_SRC</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"[INFO] 서비스 설정"</span>
    <span class="nb">cp</span> <span class="s2">"</span><span class="nv">$SERVICE_SRC</span><span class="s2">"</span> /etc/systemd/system/mariadb.service
    <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s|/usr/local/mysql|</span><span class="nv">$INSTALL_DIR</span><span class="s2">|g"</span> /etc/systemd/system/mariadb.service
    systemctl daemon-reload
    systemctl <span class="nb">enable </span>mariadb
    systemctl start mariadb <span class="o">||</span> <span class="nb">true
    echo</span> <span class="s2">"[SUCCESS] 서비스 시작 완료, 상태확인: systemctl status mariadb"</span>

  <span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"[ERROR] mariadb.service 파일을 찾을 수 없음"</span> <span class="o">&gt;</span>&amp;2
      <span class="nb">echo</span> <span class="s2">"[HOW TO FIX]"</span>
      <span class="nb">echo</span> <span class="s2">"  1) 설치 디렉터리에서 service 파일 검색: find </span><span class="nv">$INSTALL_DIR</span><span class="s2"> -type f -name mariadb.service"</span>
      <span class="nb">echo</span> <span class="s2">"  2) 해당 파일을 /etc/systemd/system/ 디렉터리에 복사: sudo cp &lt;경로&gt; /etc/systemd/system/mariadb.service"</span>
      <span class="nb">echo</span> <span class="s2">"  3) systemd 다시 로드 및 서비스 활성화/시작:"</span>
      <span class="nb">echo</span> <span class="s2">"       sudo systemctl daemon-reload"</span>
      <span class="nb">echo</span> <span class="s2">"       sudo systemctl enable mariadb"</span>
      <span class="nb">echo</span> <span class="s2">"       sudo systemctl start mariadb"</span>
      <span class="nb">exit </span>1
  <span class="k">fi
else
  </span><span class="nb">echo</span> <span class="s2">"[INFO] 크론 설정"</span>
  <span class="nb">sudo</span> <span class="nt">-u</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">/bin/mysqld_safe"</span> <span class="se">\</span>
      <span class="nt">--basedir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">"</span> <span class="se">\</span>
      <span class="nt">--datadir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">/data"</span> <span class="o">&gt;</span> /var/log/mariadb.log 2&gt;&amp;1 &amp;

  <span class="o">(</span>
    crontab <span class="nt">-l</span> 2&gt;/dev/null <span class="se">\</span>
    | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nt">-F</span> <span class="s2">"</span><span class="nv">$INSTALL_DIR</span><span class="s2">/bin/mysqld_safe"</span> <span class="o">||</span> <span class="nb">true
    echo</span> <span class="s2">"@reboot sudo -u </span><span class="nv">$USER</span><span class="s2"> </span><span class="nv">$INSTALL_DIR</span><span class="s2">/bin/mysqld_safe --basedir=</span><span class="nv">$INSTALL_DIR</span><span class="s2"> --datadir=</span><span class="nv">$INSTALL_DIR</span><span class="s2">/data &gt;&gt; /var/log/mariadb.log 2&gt;&amp;1 &amp;"</span>
  <span class="o">)</span> | crontab -

  <span class="nb">echo</span> <span class="s2">"[SUCCESS] mysqld_safe 시작 완료, 크론 등록 완료"</span>
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">"=== MariaDB 설치 및 서비스 구동 완료 ==="</span>
<span class="nb">echo</span> <span class="s2">"DB 접속할 계정에서 1회만 실행: source /etc/profile.d/mariadb.sh"</span>
<span class="nb">echo</span> <span class="s2">"접속: mysql -u root"</span>
</code></pre></div></div>

<blockquote>
  <h4 id="완성">완성</h4>
  <hr />
</blockquote>

<p><img src="/assets/images/posts/Development/ShellScript/2025-08-04-Install MariaDB/img01.webp" alt="img01" /></p>

<p>이후 계정 생성이나 튜닝이나 기타 등등은 재주껏 하는 것</p>

<blockquote>
  <h4 id="반성">반성</h4>
  <hr />
</blockquote>

<p>생각해보니 크론탭 등록 분기 추가했으면 삭제 시 크론도 삭제해야하는데 빼먹었다!!!<br />
아 이제와서 손대기 귀찮으니 다음에 사고나면 고쳐보자.</p>

<p>OS는 유닉스를 가져오지 않는 이상 웬만하면 돌아갈 것 같다.<br />
버전도 10 버전, 11버전만 써보긴 했는데 뭐 크게 바뀌는거 아니면 웬만하면 돌아가지 않을까?</p>

<p>이 스크립트가 안돌아갈 정도로 버전이 바뀌면 어차피 나도 이 스크립트의 존재를 까먹고 지낼 것 같긴 하다.</p>

<blockquote>
  <h4 id="코드-확인">코드 확인</h4>
  <hr />
</blockquote>

<p><a href="https://raw.githubusercontent.com/movingwoo/movingwoo-snippets/refs/heads/main/Development/ShellScript/2025-08-04-Install%20MariaDB.sh">Link to GitHub</a></p>]]></content><author><name>movingwoo</name></author><category term="Development/ShellScript/" /><category term="SHELL" /><category term="마리아디비 설치" /><summary type="html"><![CDATA[마리아디비 설치 스크립트 개발]]></summary></entry></feed>